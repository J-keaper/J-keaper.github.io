<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32×32.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16×16.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Keaper&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Keaper&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Keaper&#39;s Blog">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Keaper's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Keaper's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/28/JAVA-日志简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keaper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keaper's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/28/JAVA-日志简介/" itemprop="url">
                  JAVA 日志简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-28 20:43:00" itemprop="dateCreated datePublished" datetime="2018-10-28T20:43:00+00:00">2018-10-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-08 14:04:51" itemprop="dateModified" datetime="2019-03-08T14:04:51+00:00">2019-03-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当我们开发应用程序时，它可能不会按照我们预期的运行，这个时候通常我们会DEBUG，来观察程序中的代码分支(if,else)，观察一些变量在运行中的值等等以便确定程序的运行过程。但是，在生产环境，我们通常没有办法，或者不能够很容易去进行DEBUG。因此，更好的方法是使用日志工具。<br>在生产环境中，日志是查找问题来源的重要依据。应用程序运行时的产生的各种信息，包括记录程序运行时产生的错误信息、状态信息、调试信息和执行时间信息等等，都可以通过日志来进行记录。</p>
<p>在JAVA中，有哪些记录日志的方法呢？<br>介绍之前我们对下文做如下约定：</p>
<blockquote>
<ol>
<li>依赖方式均以<code>maven denpendency</code>方式给出。</li>
<li>下文所说的<code>系统属性</code>指的是<code>java</code>中的<code>System Property</code>,即通过<code>System.setProperty</code>设置或者通过<code>java -D</code>设置的系统属性。</li>
<li>本文只会简单介绍各个日志库的配置方式及基本用法，详细的配置项及更高级的用法请移步官方文档。</li>
</ol>
</blockquote>
<h2 id="最原始的方式"><a href="#最原始的方式" class="headerlink" title="最原始的方式"></a>最原始的方式</h2><p>你一定记得在刚开始学习Java时,下面这种写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"variable is :"</span> + variable);</span><br></pre></td></tr></table></figure></p>
<p>或者这样，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    …………            </span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在程序中打印变量的值，在异常发生时打印异常栈，这都有助于分析程序的运行过程，但是这种方式缺乏灵活性，一般也只会在初学时用到。</p>
<p>严格来说，这根本算不上记录日志。。。<br>我们需要的日志工具库至少应该满足：</p>
<ol>
<li>输出目标(也就是日志库中<code>appender</code>或者<code>handler</code>)<br>上述方式会将日志打印到控制台，但是在现实的应用场景中，我们可能需要将输出到文件系统，数据库，数据总线等系统中。</li>
<li>环境(可以灵活的设置日志级别<code>level</code>)<br>我们需要根据环境不同来决定是否输出某些日志信息，生产环境只输出必要的信息，而在非生产环境，更多的调试信息会更有助于我们解决问题。  </li>
</ol>
<h2 id="JDKLog-JUL"><a href="#JDKLog-JUL" class="headerlink" title="JDKLog(JUL)"></a>JDKLog(JUL)</h2><p>JDK在<code>java.util.logging</code>包下提供了日志相关的API，不过在JDK1.4才加入，在此之前，JDK中并不包含日志记录相关的API和实现。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>不需要任何外部依赖，JDK自身提供的。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>JDK通过<code>java.util.logging.config.file</code>系统属性来读取自定义配置文件的位置，如果不配置，JDK中有默认的配置文件，位置在<code>[path/to/jre]/lib/logging.properties</code>。</p>
<h4 id="配置文件示例"><a href="#配置文件示例" class="headerlink" title="配置文件示例"></a>配置文件示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 全局的日志handler</span><br><span class="line">handlers= java.util.logging.ConsoleHandler,java.util.logging.FileHandler</span><br><span class="line"># 全局的日志级别</span><br><span class="line">.level= INFO</span><br><span class="line"></span><br><span class="line"># ConsoleHandler配置level以及formater</span><br><span class="line">java.util.logging.ConsoleHandler.level = INFO</span><br><span class="line">java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter</span><br><span class="line"># SimpleFormatter的格式</span><br><span class="line">java.util.logging.SimpleFormatter.format = %1$tc [%4$s]:%5$s %n</span><br><span class="line"></span><br><span class="line"># FileHandler配置</span><br><span class="line">java.util.logging.FileHandler.pattern = %h/java%u.log</span><br><span class="line">java.util.logging.FileHandler.limit = 50000</span><br><span class="line">java.util.logging.FileHandler.count = 1</span><br><span class="line">java.util.logging.FileHandler.formatter = java.util.logging.XMLFormatter</span><br></pre></td></tr></table></figure>
<p><code>SimpleFormatter.format</code>如何自定义格式？参见：<br><a href="https://docs.oracle.com/javase/7/docs/api/java/util/logging/SimpleFormatter.html#method_detail" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/util/logging/SimpleFormatter.html#method_detail</a></p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Logger.getLogger(String name),参数为logger的name，通常为类的全限定名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = Logger.getLogger(App.class.getName());</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.severe(<span class="string">"This is test Exception:"</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h2><p>Log4j 是Apache的一个用于JAVA的日志库。是出现较早的日志工具，目前已经发展到Log4j2.X，但是这里我们讨论的是Log4j1.X，Log4j2.X下文会单独讨论。</p>
<h3 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>Log4j没有任何默认的日志配置，如果没有配置文件。你将会遇到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log4j:WARN No appenders could be found for logger (xx.xx.xx).</span><br><span class="line">log4j:WARN Please initialize the log4j system properly.</span><br><span class="line">log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span><br></pre></td></tr></table></figure></p>
<p>我们看下Log4j默认的初始化过程(具体过程在<code>org.apache.log4j.LogManager</code>类中)：</p>
<ol>
<li>设置<code>log4j.defaultInitOverride</code>为除了<code>false</code>之外的其他值都会导致<code>Log4j</code>跳过初始化过程。(但是一般我们不会这么做)</li>
<li>试图将<code>log4j.configuration</code>系统属性转换为一个<code>URL</code>(<code>java.net.URL</code>),从该URL加载配置,如果转换失败，则从<code>classpath</code>中寻找<code>log4j.configuration</code>系统属性配置的文件,从该文件加载配置</li>
<li>如果没有设置<code>log4j.configuration</code>属性，则在<code>classpath</code>目录下寻找<code>log4j.xml</code>文件，从该文件加载配置。</li>
<li>如果仍然没有，则在<code>classpath</code>目录下寻找<code>log4j.properties</code>文件，从该文件加载配置。</li>
<li>如果以上均失败了，中止初始化。</li>
</ol>
<p>从以上流程可以看出，最简单的配置方式就是提供<code>log4j.xml</code>或者<code>log4j.properties</code>文件。</p>
<h4 id="log4j-xml文件示例："><a href="#log4j-xml文件示例：" class="headerlink" title="log4j.xml文件示例："></a><code>log4j.xml</code>文件示例：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE log4j:configuration PUBLIC "-//APACHE//DTD LOG4J 1.2//EN" "log4j.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log4j:configuration</span> <span class="attr">xmlns:log4j</span>=<span class="string">'http://jakarta.apache.org/log4j/'</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置Console Appender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.PatternLayout"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"ConversionPattern"</span> <span class="attr">value</span>=<span class="string">"[%-5p %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%t] %l [%m]%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置File Appender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.FileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件位置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"File"</span> <span class="attr">value</span>=<span class="string">" out.log"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"Append"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"org.apache.log4j.PatternLayout"</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"ConversionPattern"</span> <span class="attr">value</span>=<span class="string">"[%-5p %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] [%t] %l [%m]%n"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--配置Logger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"cn.keaper"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"debug"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"file"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"debug"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"stdout"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">log4j:configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Logger.getLogger()可以传递string作为 logger name</span></span><br><span class="line">    <span class="comment">//也可以传递Class，此时则用类的全限定名作为 logger name</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(App.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.error(<span class="string">"This is test Exception:"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="休息一下"><a href="#休息一下" class="headerlink" title="休息一下"></a>休息一下</h2><blockquote>
<p>除了 <code>JUL</code> 和 <code>Log4J</code>这样的日志记录库之外，还有一类库用来封装不同的日志记录库。这样的封装库中一开始以 <code>Apache Commons  Logging</code>框架最为流行，现在比较流行的是<code>SLF4J</code>。这样封装库的API都比较简单，只是在日志记录库的API基础上做了一层简单的封装，屏蔽不同实现之间的区别。</p>
</blockquote>
<p>这样做典型的好处是可以在一个公共的项目中，可以通过这类公共的API去操作日志，但是具体的实现由调用方去指定。这样可以避免在依赖多个不同的日志库时需要对多种不同的日志库提供实现及配置。</p>
<h2 id="commoning-log-JCL"><a href="#commoning-log-JCL" class="headerlink" title="commoning-log(JCL)"></a>commoning-log(JCL)</h2><blockquote>
<p>JCL provides thin-wrapper Log implementations for other logging tools, including Log4J, Avalon LogKit (the Avalon Framework’s logging infrastructure), JDK 1.4, and an implementation of JDK 1.4 logging APIs (JSR-47) for pre-1.4 systems.</p>
</blockquote>
<p>JCL内置支持的日志实现工具包括<code>Log4J</code>、<code>Avalon LogKit</code>(项目目前已经关闭)、JDK 1.4和为JDK1.4之前系统提供的JDK log API的实现(JSR-47)。这几个中使用最多的还是<code>Log4j</code>。</p>
<h3 id="依赖-2"><a href="#依赖-2" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>为了实现具体的日志实现，则需要引入具体的依赖库，如果用<code>Log4j</code>，那么需要引入<code>Log4j</code>的依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><p><code>JCL</code>的配置文件是<code>classpath</code>路径中的<code>commons-logging.properties</code>。<code>JCL</code>中使用<code>LogFactory</code>来获取具体的<code>Log</code>,<code>LogFactory</code>可以通过<code>org.apache.commons.logging.LogFactory</code>属性指定，当然<code>JCL</code>提供了默认的<code>LogFactory</code>,默认的<code>Logfactory</code>通过如下流程决定使用哪种具体的日志实现：</p>
<ol>
<li>寻找<code>LogFactory</code>中名为<code>org.apache.commons.logging.Log</code>(同时兼容1.0版本之前的<code>org.apache.commons.logging.log</code>)的属性指定的<code>Log</code>。  <blockquote>
<p>这里的属性指的是通过<code>LogFactory</code>类的<code>getAttribute</code>方法获得的，注意定义在<code>commons-logging.properties</code>文件中的每个属性都会成为这个默认的<code>LogFactory</code>的<code>Attribte</code>.</p>
</blockquote>
</li>
<li>如果没有找到，寻找系统属性中名为<code>org.apache.commons.logging.Log</code>(同时兼容1.0版本之前的<code>org.apache.commons.logging.log</code>)的属性指定的<code>Log</code>。</li>
<li>如果依然没有找到，<code>Log4j</code>是可用的(可以找到<code>Log4j</code>相关的类),使用<code>Log4j</code>。</li>
<li>如果没有找到<code>Log4j</code>，JDK版本在1.4以上，那么使用<code>JDKLog</code>。</li>
<li>使用JCL内置的<code>SimpleLog</code>。</li>
</ol>
<p>如果我们使用<code>Log4j</code>，<code>JDKLog</code>，我们可以不用配置<code>commons-logging</code>,注意着并不等于不用配置<code>Log4j</code>或者<code>JDKLog</code>，在使用了<code>commons-logging</code>之后，不管是<code>Log4j</code>还是<code>JDKLog</code>，配置方式都是与单独使用时是相同的，<code>commoons-logging</code>和具体的日志实现的配置是分开的。</p>
<h3 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(App.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.error(<span class="string">"This is test Exception:"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="slf4j"><a href="#slf4j" class="headerlink" title="slf4j"></a>slf4j</h2><p><code>slf4j</code>与<code>commons-logging</code>相似，是有一个日志门面框架。<br><code>slf4j</code>支持<code>log4j</code>,<code>JDKLog</code>,<code>logback</code>同时支持<code>commons-logging</code>(相当于两层门面)。</p>
<h3 id="依赖-3"><a href="#依赖-3" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>slf4j-api</code>提供Log的接口，而具体使用哪种实现则需要提供另一类包：绑定包(<code>SLF4J bindings</code>)，每一种绑定包对应一种实现：</p>
<table>
<thead>
<tr>
<th style="text-align:center">binding jar</th>
<th style="text-align:center">支持日志实现</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>slf4j-log4j12.jar</code></td>
<td style="text-align:center">log4j 1.2</td>
</tr>
<tr>
<td style="text-align:center"><code>slf4j-jdk14.jar</code></td>
<td style="text-align:center">JDKLog</td>
</tr>
<tr>
<td style="text-align:center"><code>slf4j-jcl.jar</code></td>
<td style="text-align:center">commons-logging</td>
</tr>
</tbody>
</table>
<p>同时<code>logback</code>内置slf4j实现，所以使用<code>logback</code>并不需要<code>binding jar</code>。<br><img src="https://blog-picture.nos-eastchina1.126.net/picture0005.png" alt=""></p>
<p>引入了对应的<code>binding jar</code>之后，我们还需要引入日志实现库所需要的依赖。<br>例如如果我们用<code>Log4j</code>作为日志实现，除了<code>slf4j-api</code>需要引入，还需要引入<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><p><code>Slf4j</code>并不需要单独配置，只要引入相应日志的<code>binding jar</code>以及其对应依赖并配置即可。</p>
<p>这里的绑定实际上是加载<code>org.slf4j.impl.StaticLoggerBinder</code>类，每个<code>binding jar</code>中都有这样一个类。如果找到多个绑定，则取决于加载的先后顺序。</p>
<h3 id="用法-2"><a href="#用法-2" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(App.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.error(<span class="string">"This is test Exception:"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="slf4j-bridging"><a href="#slf4j-bridging" class="headerlink" title="slf4j bridging"></a>slf4j bridging</h3><p>如果在你依赖的模块中使用了别的日志库，而在你的项目中你使用的是<code>slf4j</code>,这个时候<code>slf4j</code> 提供了一些桥接模块可以避免你同时对多个日志库进行配置，这些桥接模块可以重定向对其他日志库的调用到<code>slf4j</code>.<br>官方图表达的很清晰：<br><img src="https://blog-picture.nos-eastchina1.126.net/picture0006.png" alt=""></p>
<h2 id="Logback"><a href="#Logback" class="headerlink" title="Logback"></a>Logback</h2><p><code>Logback</code>是由<code>Log4j</code>创始人设计的又一个开源日日志组件。<code>Logback</code>当前分成三个模块：<code>logback-core</code>,<code>logback-classic</code>和<code>logback-access</code>。<br><code>logback-core</code>是其它两个模块的基础模块。<code>logback-classic</code>是<code>log4j</code>的一个改良版本。此外<code>logback-classic</code>完整实现了<code>SLF4J  API</code>，使你可以很方便地更换成其它日记系统如<code>Log4J</code>或<code>JDK14 Logging</code>。<code>logback-access</code>模块可以与Servlet容器集成以提供HTTP日志相关的功能。</p>
<h3 id="依赖-4"><a href="#依赖-4" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>logback-classic</code>这个包内部依赖<code>logback-coer</code>和<code>slf4j-api</code>。所以不需要再额外引入。另外我们在上一节说到，logback提供了对slf4j接口的原生实现，所以不需要提供<code>bingding jar</code>。</p>
<h3 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h3><p>logback通过以下步骤完成初始化：</p>
<ol>
<li>logback尝试在classpath目录下寻找<code>logback-test.xml</code>文件。</li>
<li>如果不存在，logback尝试在classpath目录下寻找<code>logback.groovy</code>文件。</li>
<li>如果不存在，logback尝试在classpath目录下寻找<code>logback.xml</code>文件。</li>
<li>如果都不存在，在classpath目录下寻找<code>META-INF\services\ch.qos.logback.classic.spi.Configurator</code>,这个文件的内容是<code>com.qos.logback.classic.spi.Configurator</code>接口的实现类的全限定名，logback将使用该类作为配置类。</li>
<li>如果仍然没有找到，那么logback使用默认的<code>BasicConfigurator</code>类作为配置类，这个<code>Configurator</code>将日志输出至控制台。</li>
</ol>
<p><code>logback.xml</code>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"  encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Console Appender配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- encoders are  by default assigned the type</span></span><br><span class="line"><span class="comment">             ch.qos.logback.classic.encoder.PatternLayoutEncoder --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--File Appender配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.FileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>myApp.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%date %level [%thread] %logger&#123;10&#125; [%file:%line] %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"cn.keaper"</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="用法-3"><a href="#用法-3" class="headerlink" title="用法"></a>用法</h3><p>既然logback内置了对slf4j的实现，那么他的使用方式就和slf4j的使用方式一样。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(App.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.error(<span class="string">"This is test Exception:"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Log4j-2"><a href="#Log4j-2" class="headerlink" title="Log4j 2"></a>Log4j 2</h2><p>以上我们说的全部都是<code>Log4j 1</code>,而<code>Log4j</code>现在已经升级到了<code>2.X</code>版本。<code>Log4j 2</code>已经不仅仅是一个日志实现框架了，他也能够作为一个门面框架来使用，并提供对其他框架丰富的支持。我们只介绍他单纯作为一个日志实现框架的用法，更多的用法请移步官网自行查阅。</p>
<h3 id="依赖-5"><a href="#依赖-5" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-5"><a href="#配置-5" class="headerlink" title="配置"></a>配置</h3><p><code>Log4j 2</code>通过初始化实现自动配置的流程如下：</p>
<ol>
<li>检查<code>log4j.configurationFile</code>系统属性，如果有设置，将使用</li>
<li>如果没有设置，依次从classpath中寻找配置文件,顺序依次为：<ul>
<li><code>log4j2-test.properties</code></li>
<li><code>log4j2-test.yaml</code>或者<code>log4j2-test.yml</code></li>
<li><code>log4j2-test.json</code>或者<code>log4j2-test.jsn</code></li>
<li><code>log4j2-test.xml</code></li>
<li><code>log4j2.properties</code></li>
<li><code>log4j2.yaml</code>或者<code>log4j2.yml</code></li>
<li><code>log4j2.json</code>或者<code>log4j2.jsn</code></li>
<li><code>log4j2.xml</code><br>3.如果这么多文件都没有没有找到，则会有一个默认的配置，这个配置会将日志输出至控制台。</li>
</ul>
</li>
</ol>
<p>Log4J2.X的xml配置方式上有一些不同,主要的不同可以看这里：<a href="https://logging.apache.org/log4j/2.x/manual/migration.html" target="_blank" rel="noopener">Migrating from Log4j 1.x</a>  </p>
<p><code>log4j2.xml</code>配置文件示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置Console Appender--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置File Appender--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">filename</span>=<span class="string">"out.log"</span> <span class="attr">append</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"cn.keaper"</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"debug"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="用法-4"><a href="#用法-4" class="headerlink" title="用法"></a>用法</h3><p>在使用方式上，也有了变化，主要变化是在Log4J1.X中Logger是具体的类，而在Log4J2.X中，Logger变成了接口(log4j-api包中)，在log4j-core中提供具体实现。这样做的好处是使用log4j的api同时可以使用其他不同日志库的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意类的位置不同了</span></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Log4j 1.x中可以使用Logger.gerLogger()来获取Logger</span></span><br><span class="line">    <span class="comment">//但是在Log4j 2.X中需要使用LogManager.getLogger()来获取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LogManager.getLogger(App.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            logger.info(<span class="string">"This is test log."</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"test Exception"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            logger.error(<span class="string">"This is test Exception:"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="几种框架的关系"><a href="#几种框架的关系" class="headerlink" title="几种框架的关系"></a>几种框架的关系</h2><p>以上介绍的这几种框架可以分为两类(log4j 2 暂时不做区分)：</p>
<ol>
<li>JUL, Log4j 1 和 Logback 是真正的日志实现。</li>
<li>commons-logging和sl4j是在真正日志实现之上的门面框架。每个框架都有自己一个简单实现，也可以使用一个另外的日志实现。</li>
</ol>
<p>commons-logging和slf4j都可以作为JDKLog和Log4j 1的日志门面，此外slf4j还能够作为commons-logging本身和logback的门面框架。<br>他们之间的关系可以用下图表示：<br><img src="https://blog-picture.nos-eastchina1.126.net/picture0007.png" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/logging/overview.html" target="_blank" rel="noopener">JDKLog文档</a></li>
<li><a href="http://logging.apache.org/log4j/1.2/manual.html" target="_blank" rel="noopener">Log4J1.X文档</a></li>
<li><a href="https://logging.apache.org/log4j/2.x/" target="_blank" rel="noopener">Log4j2.X文档</a></li>
<li><a href="https://commons.apache.org/proper/commons-logging/guide.html" target="_blank" rel="noopener">commons-loggging</a></li>
<li><a href="https://logback.qos.ch/manual/index.html" target="_blank" rel="noopener">logback文档</a></li>
<li><a href="https://note.youdao.com/" target="_blank" rel="noopener">Java日志管理最佳实践</a></li>
<li><a href="https://www.javacodegeeks.com/2011/09/java-logging-mess.html" target="_blank" rel="noopener">The Java Logging Mess</a></li>
<li><a href="https://vectorbeta.wordpress.com/2014/08/26/the-java-logging-quagmire/" target="_blank" rel="noopener">The Java logging quagmire</a></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/23/webpack-配置antd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keaper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keaper's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/23/webpack-配置antd/" itemprop="url">
                  webpack 配置antd
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-23 23:09:00" itemprop="dateCreated datePublished" datetime="2018-02-23T23:09:00+00:00">2018-02-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-08 14:04:51" itemprop="dateModified" datetime="2019-03-08T14:04:51+00:00">2019-03-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="webpack配置antd"><a href="#webpack配置antd" class="headerlink" title="webpack配置antd"></a>webpack配置antd</h2><p>webpack配置文件 wepack.config.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//省略</span></span><br><span class="line"><span class="built_in">module</span>:&#123;</span><br><span class="line">        rules: [&#123;</span><br><span class="line">            test: <span class="regexp">/\.js[x]?$/</span>,</span><br><span class="line">            use:[<span class="string">'babel-loader?cacheDirectory=true'</span>],</span><br><span class="line">            include:path.join(__dirname,<span class="string">'./src/'</span>)</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: <span class="string">"style-loader"</span></span><br><span class="line">                &#125;, &#123;</span><br><span class="line">                    loader: <span class="string">"css-loader"</span></span><br><span class="line">                &#125;,</span><br><span class="line">            ]</span><br><span class="line">        &#125;,]</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">//省略</span></span><br></pre></td></tr></table></figure></p>
<p>bable配置文件 .bablerc：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"es2015"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"stage-0"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"plugins"</span>: [[</span><br><span class="line">    <span class="string">"import"</span>, &#123;</span><br><span class="line">      <span class="string">"libraryName"</span>: <span class="string">"antd"</span>,</span><br><span class="line">      <span class="string">"style"</span>: <span class="string">"css"</span></span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>babel-plugin-import 插件用法：<a href="https://github.com/ant-design/babel-plugin-import#usage" target="_blank" rel="noopener">https://github.com/ant-design/babel-plugin-import#usage</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/21/IDEA-问题集锦/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keaper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keaper's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/21/IDEA-问题集锦/" itemprop="url">
                  IntelliJ IDEA知识集锦
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-21 23:28:00" itemprop="dateCreated datePublished" datetime="2018-01-21T23:28:00+00:00">2018-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-08 14:04:51" itemprop="dateModified" datetime="2019-03-08T14:04:51+00:00">2019-03-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>非常完整的IDEA概念及常见问题：</p>
<p><a href="https://blog.gmem.cc/intellij-idea-faq" target="_blank" rel="noopener">https://blog.gmem.cc/intellij-idea-faq</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/07/tcpip复习总结(2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keaper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keaper's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/07/tcpip复习总结(2)/" itemprop="url">
                  TCP/IP网络编程复习总结(2)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-06-07 18:47:00" itemprop="dateCreated datePublished" datetime="2017-06-07T18:47:00+00:00">2017-06-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-08 14:04:51" itemprop="dateModified" datetime="2019-03-08T14:04:51+00:00">2019-03-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第十章-多进程服务器端"><a href="#第十章-多进程服务器端" class="headerlink" title="第十章 多进程服务器端"></a>第十章 多进程服务器端</h1><h2 id="1-进程该概念及应用"><a href="#1-进程该概念及应用" class="headerlink" title="1. 进程该概念及应用"></a>1. 进程该概念及应用</h2><ul>
<li>并发服务端实现方法<ul>
<li>多进程服务器</li>
<li>多路复用服务器</li>
<li>多线程服务器</li>
</ul>
</li>
<li>创建进程 fork()函数<ul>
<li>头文件：<code>&lt;unistd.h&gt;</code></li>
<li>原型：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> fork(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>- 参数：空
- 返回值：在父进程中fork返回子进程ID，在子进程中返回0
</code></pre><ul>
<li>fork函数示例  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> lval =<span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">        lval+=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        lval-=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)	<span class="comment">//子进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"child proc : %d \n"</span>,lval);</span><br><span class="line">    <span class="keyword">else</span> 		<span class="comment">//父进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"parent proc : %d \n"</span>,lval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">parent proc : 18 </span></span><br><span class="line"><span class="comment">child proc : 22</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-进程和僵尸进程"><a href="#2-进程和僵尸进程" class="headerlink" title="2. 进程和僵尸进程"></a>2. 进程和僵尸进程</h2><ul>
<li>产生僵尸进程的原因：向exit函数传递的参数值和main函数中的return语句返回的值都会传递给操作系统。但操作系统不会销毁子进程直到把这些值传递给产生该进程的父进程。处于这种状态的进程就是僵尸进程。</li>
<li>销毁僵尸进程的方法：向创建子进程的父进程传递子进程的exit参数值和return语句的返回值。</li>
</ul>
<h2 id="3-销毁僵尸进程"><a href="#3-销毁僵尸进程" class="headerlink" title="3. 销毁僵尸进程"></a>3. 销毁僵尸进程</h2><h3 id="1-wait函数"><a href="#1-wait函数" class="headerlink" title="(1) wait函数"></a>(1) wait函数</h3><ul>
<li>头文件：<code>&lt;sys/wait.h&gt;</code></li>
<li>功能：等待子进程返回</li>
<li>原型：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> wait(<span class="keyword">int</span>  * statloc);`</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>参数：调用此函数时，如果已有子进程终止，那么子进程终止时传递的返回值将保存到参数所指的内存空间。但参数指向的单元有其他信息，故需要通过宏进行分离。<ul>
<li>WIFEXITED 子进程正常终止是返回true</li>
<li>WEXITSTATUS 返回子进程的返回值</li>
</ul>
</li>
<li>返回值：成功返回终止的子进程ID，失败返回-1<br><em>调用wait函数时，如果没有已经终止的子进程，那么程序将<strong>阻塞</strong>直到有子进程终止。</em></li>
<li>示例:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid=fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child PID : %d \n"</span>,pid);</span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">7</span>);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Child PID : %d \n"</span>,pid);</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Child send: %d \n"</span>,WEXITSTATUS(status));</span><br><span class="line"></span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Child send: %d \n"</span>,WEXITSTATUS(status));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Child PID : 4775 </span></span><br><span class="line"><span class="comment">Child PID : 4776 </span></span><br><span class="line"><span class="comment">Child send: 3 </span></span><br><span class="line"><span class="comment">Child send: 7 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-waitpid函数"><a href="#2-waitpid函数" class="headerlink" title="(2) waitpid函数"></a>(2) waitpid函数</h3><ul>
<li>头文件：<code>&lt;sys/wait.h&gt;</code></li>
<li>原型：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> waitpid(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> * statloc, inoptions);`</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>参数：<ul>
<li>pid 等待终止的目标子进程ID，若传递-1，则等待任意子进程终止</li>
<li>statloc 与wait函数意义相同</li>
<li>options 传递头文件<code>&lt;sys/wait.h&gt;</code>中的常量WNOHANG，即时没有终止的子进程也<strong>不会进入阻塞状态</strong>，而是返回0并退出函数。</li>
</ul>
</li>
<li>返回值：<br>  成功是返回终止的子进程ID（或者0），失败时返回-1</li>
<li>示例<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">15</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(!waitpid(<span class="number">-1</span>,&amp;status,WNOHANG))</span><br><span class="line">        &#123;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"sleep 3 sec."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Child send %d \n"</span>,WEXITSTATUS(status));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">sleep 3 sec.</span></span><br><span class="line"><span class="comment">sleep 3 sec.</span></span><br><span class="line"><span class="comment">sleep 3 sec.</span></span><br><span class="line"><span class="comment">sleep 3 sec.</span></span><br><span class="line"><span class="comment">sleep 3 sec.</span></span><br><span class="line"><span class="comment">Child send 24</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4-信号处理"><a href="#4-信号处理" class="headerlink" title="4. 信号处理"></a>4. 信号处理</h2><h3 id="1-信号"><a href="#1-信号" class="headerlink" title="(1)信号"></a>(1)信号</h3><ul>
<li>信号是在特定事件发生时由操作系统向进程发送的信息</li>
</ul>
<h3 id="2-signal函数"><a href="#2-signal函数" class="headerlink" title="(2)signal函数"></a>(2)signal函数</h3><ul>
<li>功能：注册信号</li>
<li>头文件：<code>&lt;signal.h&gt;</code></li>
<li>原型：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*signal(<span class="keyword">int</span> signo,<span class="keyword">void</span>(*func)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>参数：<ul>
<li>func : 信号发出时要调用的函数，该函数是参数类型为int，返回void型的函数ji</li>
<li>signo: 需要处理的信号</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">信号</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SIGALRM</td>
<td style="text-align:center">已到通过调用alarm函数注册的时间</td>
</tr>
<tr>
<td style="text-align:center">SIGINT</td>
<td style="text-align:center">程序终止信号，通常是输入Ctrl+C</td>
</tr>
<tr>
<td style="text-align:center">SIGCHLD</td>
<td style="text-align:center">子进程终止</td>
</tr>
</tbody>
</table>
<ul>
<li>返回值：返回之前注册的函数指针（参数类型为int，返回void型的函数）</li>
<li>示例:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeout</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"time out"</span>);</span><br><span class="line">    alarm(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">keycontrol</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Ctrl+C pressed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal(SIGALRM,timeout);</span><br><span class="line">    signal(SIGINT,keycontrol);</span><br><span class="line">    alarm(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"wait..."</span>);</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">time out</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">^CCtrl+C pressed</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">time out</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><em>注：信号的产生会唤醒由于调用sleep函数而进入阻塞状态的进程，进程一旦被唤醒就不会再进入睡眠状态。</em></p>
<h3 id="3-alarm函数"><a href="#3-alarm函数" class="headerlink" title="(3) alarm函数"></a>(3) alarm函数</h3><ul>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">alarm</span> <span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> seconds)</span></span>;`</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：如果传递一个正整型参数，则相应时间到达（以秒为单位）后将产生SIGALRM信号。若传递参数0，则取消之前的对 SIGNAL信号的预约。</p>
</li>
<li>返回值：返回0或者，以秒为单位的距SIGNAL信号发生所剩的时间</li>
</ul>
<h3 id="4-sigaction函数"><a href="#4-sigaction函数" class="headerlink" title="(4) sigaction函数"></a>(4) sigaction函数</h3><ul>
<li>原型：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span> <span class="params">(<span class="keyword">int</span> signo, <span class="keyword">const</span> struct sigaction *act,</span></span></span><br><span class="line"><span class="function"><span class="params">				struct sigaction *oldact)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>参数：<ul>
<li>signo 传递信号信息</li>
<li>act 对应于第一个参数的信号处理函数信息。</li>
<li>oldact 通过此参数获取之前注册的信号处理函数指针，若不处理则传递0</li>
</ul>
</li>
<li>返回值：成功返回0,失败返回-1</li>
<li><p>struct结构体:</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*sa_handler) (<span class="keyword">void</span>);</span><br><span class="line">    <span class="keyword">sigset_t</span> sa_mask;</span><br><span class="line">    <span class="keyword">int</span> sa_flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeout</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(sig==SIGALRM)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Time out"</span>);</span><br><span class="line">    alarm(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    <span class="comment">//注册信号</span></span><br><span class="line">    act.sa_handler=timeout;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags=<span class="number">0</span>;</span><br><span class="line">    sigaction(SIGALRM,&amp;act,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    alarm(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"wait..."</span>);</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">Time out</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">Time out</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">Time out</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="5-利用信号处理技术消灭僵尸进程"><a href="#5-利用信号处理技术消灭僵尸进程" class="headerlink" title="(5) 利用信号处理技术消灭僵尸进程"></a>(5) 利用信号处理技术消灭僵尸进程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_child</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = waitpid(<span class="number">-1</span>,&amp;status,WNOHANG);</span><br><span class="line">    <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Remove proc id : %d \n"</span>,pid);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child send : %d \n"</span>,WEXITSTATUS(status));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    act.sa_handler=read_child;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags=<span class="number">0</span>;</span><br><span class="line">    sigaction(SIGCHLD,&amp;act,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child PID : %d \n"</span>,pid);</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"wait..."</span>);</span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Child PID : 5119 </span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">Remove proc id : 5119 </span></span><br><span class="line"><span class="comment">Child send : 12 </span></span><br><span class="line"><span class="comment">wait...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="5-基于多任务的并发服务器"><a href="#5-基于多任务的并发服务器" class="headerlink" title="5. 基于多任务的并发服务器"></a>5. 基于多任务的并发服务器</h2><ul>
<li>为每个客户端都创建一个进程提供服务</li>
<li>实现并发服务器<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_child</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = waitpid(<span class="number">-1</span>,&amp;status,WNOHANG);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Remove proc id ; %d \n"</span>,pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock,clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>,<span class="title">clnt_addr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> clnt_addr_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册信号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    act.sa_handler = read_child;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(sigaction(SIGCHLD,&amp;act,<span class="number">0</span>)==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"sigaction() error"</span>);</span><br><span class="line">    <span class="comment">//创建套接字</span></span><br><span class="line">    serv_sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(serv_sock==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line">    <span class="comment">//地址初始化</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">    serv_addr.sin_family=AF_INET;</span><br><span class="line">    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bind(serv_sock,(struct sockaddr*) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listen(serv_sock,<span class="number">5</span>)==<span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        clnt_addr_size = <span class="keyword">sizeof</span>(clnt_addr);</span><br><span class="line">        clnt_sock = accept(serv_sock,(struct sockaddr*) &amp;clnt_addr,&amp;clnt_addr_size);</span><br><span class="line">        <span class="keyword">if</span>(clnt_sock==<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"new connection !"</span>);</span><br><span class="line"></span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>) <span class="comment">//子进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            close(serv_sock); <span class="comment">//子进程关闭监听套接字</span></span><br><span class="line">            <span class="keyword">int</span> str_len;</span><br><span class="line">            <span class="keyword">while</span>((str_len=read(clnt_sock,buf,BUF_SIZE))!=<span class="number">0</span>)</span><br><span class="line">                write(clnt_sock,buf,str_len);</span><br><span class="line"></span><br><span class="line">            close(clnt_sock);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"client disconnected !"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            close(clnt_sock);  <span class="comment">//父进程关闭数据传输的套接字</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-分割TCP的I-O程序"><a href="#6-分割TCP的I-O程序" class="headerlink" title="6. 分割TCP的I/O程序"></a>6. 分割TCP的I/O程序</h2><h1 id="第十一章-进程间通信"><a href="#第十一章-进程间通信" class="headerlink" title="第十一章 进程间通信"></a>第十一章 进程间通信</h1><h2 id="1-进程件间通信的基本概念"><a href="#1-进程件间通信的基本概念" class="headerlink" title="1. 进程件间通信的基本概念"></a>1. 进程件间通信的基本概念</h2><p><strong>创建管道 pipe() 函数</strong></p>
<ul>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe</span><span class="params">(<span class="keyword">int</span> filedes[<span class="number">2</span>])</span></span>;`</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>filededs[0] 通过管道接受数据使用的文件描述符，即管道出口</li>
<li>filededs[1] 通过管道发送数据使用的文件描述符，即管道入口</li>
</ul>
</li>
<li>返回值：成功返回0,失败返回-1</li>
</ul>
<p><strong>通过管道实现进程间通信</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fds[<span class="number">2</span>];</span><br><span class="line">	pipe(fds);</span><br><span class="line">	<span class="keyword">char</span> str[]=<span class="string">"Who are you?"</span>;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">30</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		write(fds[<span class="number">1</span>],str,<span class="keyword">sizeof</span>(str));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		read(fds[<span class="number">0</span>],buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">		<span class="built_in">puts</span>(buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Who are you?</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p><strong>通过管道进行进程间双向通信</strong></p>
<p>一个管道在需要双向通信时会产生混乱，所以双向通信时需要两个管道用于不同方向的数据传输。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fds1[<span class="number">2</span>],fds2[<span class="number">2</span>];</span><br><span class="line">	pipe(fds1);</span><br><span class="line">	pipe(fds2);</span><br><span class="line">	<span class="keyword">char</span> str1[]=<span class="string">"How are you?"</span>;</span><br><span class="line">	<span class="keyword">char</span> str2[]=<span class="string">"I'm fine."</span>;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">30</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid =fork();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		write(fds1[<span class="number">1</span>],str1,<span class="keyword">sizeof</span>(str1));</span><br><span class="line">		read(fds2[<span class="number">0</span>],buf,<span class="number">30</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Child proc print: %s \n"</span>,buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		read(fds1[<span class="number">0</span>],buf,<span class="number">30</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Parent proc print: %s \n"</span>,buf);</span><br><span class="line">		write(fds2[<span class="number">1</span>],str2,<span class="keyword">sizeof</span>(str2));</span><br><span class="line">		sleep(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Parent proc print: How are you? </span></span><br><span class="line"><span class="comment">Child proc print: I'm fine.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<h1 id="第十二章-I-O复用"><a href="#第十二章-I-O复用" class="headerlink" title="第十二章 I/O复用"></a>第十二章 I/O复用</h1><p>多进程服务器端中，创建进程的代价较大，进程间相互通信也相对复杂。</p>
<h2 id="1-select函数"><a href="#1-select函数" class="headerlink" title="1. select函数"></a>1. select函数</h2><ul>
<li>使用selct函数可以将多个文件描述符集中到一起统一监视。</li>
<li>slect函数的调用顺序：<br><br>  <strong>设置文件描述符，指定监视范围，设置超时 ===&gt; 指定监视范围 ===&gt; 调用select函数 ===&gt; 查看调用结果</strong></li>
</ul>
<p><strong>设置文件描述符</strong></p>
<ul>
<li>select函数可以同时监视多个文件描述符，可以视为监视多个套接字。</li>
<li>首先要将监视的文件描述符集中在一起，集中时按照监视项（接受，传输，异常）进行区分。</li>
<li>fd_set数组变量，每一位状态都表示文件描述符为此下标的文件或者套接字是否处于监视范围，1表示是监视对象，0表示不是。</li>
<li>操作fd_set的宏</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">宏</th>
<th style="text-align:center">操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">FD_ZERO(fd_set *fdset)</td>
<td style="text-align:center">将fd_set变量的所有位初始化为0</td>
</tr>
<tr>
<td style="text-align:center">FD_SET(int fd,fd_set *fdset)</td>
<td style="text-align:center">在参数fdset指向的变量中注册文件描述符fd的信息，即将该位置为1</td>
</tr>
<tr>
<td style="text-align:center">FD_CLR(int fd,fd_set *fdset)</td>
<td style="text-align:center">从参数fdset指向的变量中清除文件描述符fd的信息，即将该位置为0</td>
</tr>
<tr>
<td style="text-align:center">FD_ISSET(int fd,fd_set *fdset)</td>
<td style="text-align:center">若参数fdset指向的变量中包含文件描述符fd的信息，则返回true</td>
</tr>
</tbody>
</table>
<p><strong>设置监视范围及超时select函数</strong></p>
<ul>
<li>头文件<code>&lt;sys/select.h&gt;</code></li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span> <span class="params">(<span class="keyword">int</span> maxfd, fd_set *readfds,</span></span></span><br><span class="line"><span class="function"><span class="params">       fd_set *writefds, fd_set *exceptfds,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">const</span> struct timeval *timeout)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>maxfd 监视对象文件描述符的数量</li>
<li>readfds 将所有关注”是否存在待读取数据”的文件描述符注册到fd_set型变量，并传递其地址值</li>
<li>writefds 将所有关注”是否可传输无阻塞数据”的文件描述符注册到fd_set型变量，并传递其地址值</li>
<li>exceptfds 将所有关注”是否发生异常”的文件描述符注册到fd_set型变量，并传递其地址值</li>
<li>timeout 设置超时时间</li>
</ul>
</li>
<li>timeval结构体  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> sec;	“”	<span class="comment">/* Seconds.  */</span></span><br><span class="line">    <span class="keyword">long</span> usec;	<span class="comment">/* Microseconds.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>返回值：发生错误返回-1,超时返回0。发生关注的事件返回时，返回大于0的值，该值是发生事件的文件描述符数量。</li>
</ul>
<p><strong>调用sselect函数后查看返回结果</strong></p>
<p>select函数调用完成后，向其传递的fd_set变量中将发生变化。原来为1的所有位均变为0,但发生变化的文件描述符除外。也就是值为1的位置上的文件描述副发生了变化。</p>
<p><strong>select函数调用示例</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	fd_set reads,temps;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">30</span>];</span><br><span class="line">	</span><br><span class="line">	FD_ZERO(&amp;reads);</span><br><span class="line">	FD_SET(<span class="number">0</span>,&amp;reads);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		temps = reads;</span><br><span class="line">		timeout.tv_sec = <span class="number">5</span>;</span><br><span class="line">		timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> result = select(<span class="number">1</span>,&amp;temps,<span class="number">0</span>,<span class="number">0</span>,&amp;timeout);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(result==<span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">"select() error!"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(result==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">"timeout!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(FD_ISSET(<span class="number">0</span>,&amp;temps))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">int</span> <span class="built_in">strlen</span>=read(<span class="number">0</span>,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">				buf[<span class="built_in">strlen</span>]=<span class="number">0</span>;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"message from console: %s"</span>,buf);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">hello</span></span><br><span class="line"><span class="comment">message from console: hello</span></span><br><span class="line"><span class="comment">hello</span></span><br><span class="line"><span class="comment">message from console: hello</span></span><br><span class="line"><span class="comment">world</span></span><br><span class="line"><span class="comment">message from console: world</span></span><br><span class="line"><span class="comment">timeout!</span></span><br><span class="line"><span class="comment">timeout!</span></span><br><span class="line"><span class="comment">timeout!</span></span><br><span class="line"><span class="comment">timeout!</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p><strong>实现I/O复用的服务器端</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(buf, <span class="built_in">stderr</span>);</span><br><span class="line">	fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> serv_sock,clnt_sock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>,<span class="title">clnt_addr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clnt_addr_size;</span><br><span class="line">	<span class="comment">//监视范围fd_set变量</span></span><br><span class="line">	fd_set reads,cp_reads;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建套接字变量</span></span><br><span class="line">	serv_sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(serv_sock==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line">	<span class="comment">//地址信息初始化</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">	serv_addr.sin_family=AF_INET;</span><br><span class="line">	serv_addr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">	serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(bind(serv_sock,(struct sockaddr*) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(listen(serv_sock,<span class="number">5</span>)==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line">	</span><br><span class="line">	FD_ZERO(&amp;reads);</span><br><span class="line">	FD_SET(serv_sock,&amp;reads);	<span class="comment">//监视服务端套接字</span></span><br><span class="line">	<span class="keyword">int</span> fd_max=serv_sock+<span class="number">1</span>;		<span class="comment">//设置最大监视数量</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cp_reads = reads;		<span class="comment">//备份fd_set,因为调用select函数后，fd_set会被清空</span></span><br><span class="line">		timeout.tv_sec = <span class="number">5</span>;</span><br><span class="line">		timeout.tv_usec = <span class="number">5000</span>;</span><br><span class="line">		<span class="keyword">int</span> fd_num;</span><br><span class="line">		<span class="keyword">if</span>((fd_num=select(fd_max+<span class="number">1</span>,&amp;cp_reads,<span class="number">0</span>,<span class="number">0</span>,&amp;timeout))==<span class="number">-1</span>)	<span class="comment">//调用select函数</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span>(fd_num==<span class="number">0</span>)	<span class="comment">//超时</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;fd_max+<span class="number">1</span>;i++)		</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(FD_ISSET(i,&amp;cp_reads))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(i==serv_sock) <span class="comment">//服务端监听套接字发生变化说明，有新的连接请求</span></span><br><span class="line">				&#123;</span><br><span class="line">					clnt_sock = accept(serv_sock,(struct sockaddr*) &amp;clnt_addr,&amp;clnt_addr_size);</span><br><span class="line">					FD_SET(clnt_sock,&amp;reads);	<span class="comment">//将新连接置于监控范围内</span></span><br><span class="line">					<span class="keyword">if</span>(fd_max&lt;clnt_sock)</span><br><span class="line">						fd_max=clnt_sock;		<span class="comment">//更新最大监控数量</span></span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Connected client : %d \n"</span>,clnt_sock);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> 			<span class="comment">//用于数据传输的套接字发生变化，说明有数据需要读取</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">int</span> str_len=read(i,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">					<span class="keyword">if</span>(str_len==<span class="number">0</span>)		<span class="comment">//客户端关闭连接</span></span><br><span class="line">					&#123;		</span><br><span class="line">						FD_CLR(i,&amp;reads);		<span class="comment">//移出监控范围</span></span><br><span class="line">						close(i);			</span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">"Closed clinet : %d \n"</span>,i);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> </span><br><span class="line">						write(i,buf,str_len);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	close(serv_sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="第十三章-多种I-O函数"><a href="#第十三章-多种I-O函数" class="headerlink" title="第十三章 多种I/O函数"></a>第十三章 多种I/O函数</h1><h2 id="1-send-amp-recv-函数"><a href="#1-send-amp-recv-函数" class="headerlink" title="1. send() &amp; recv()函数"></a>1. send() &amp; recv()函数</h2><p><strong>send()</strong></p>
<ul>
<li>头文件：<code>&lt;sys/socket.h&gt;</code></li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> send (<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sockfd 表示与发送数据连接的套接字文件描述符</li>
<li>buf 待发送数据的缓冲地址值</li>
<li>nbytes 待传输的字节数</li>
<li>flags 可选项</li>
</ul>
</li>
<li>返回值：成功返回发送的字节数，失败返回-1</li>
</ul>
<p><strong>recv()</strong></p>
<ul>
<li>头文件：<code>&lt;sys/socket.h&gt;</code></li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> recv (<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：    </p>
<ul>
<li>sockfd 表示与接受数据连接的套接字文件描述符</li>
<li>buf 保存接受数据的缓冲区地址值</li>
<li>nbytes 可接收的最大字节数</li>
<li>flags可选项</li>
</ul>
</li>
<li>返回值 ：成功返回收到的字节数（收到EOF返回0），失败返回-1</li>
</ul>
<p><strong>flags选项</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">flags</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">recv</th>
<th style="text-align:center">send</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MSG_OOB　　　　</td>
<td style="text-align:center">发送或接收带外数据(Out-of-band data)</td>
<td style="text-align:center">•</td>
<td style="text-align:center">•</td>
</tr>
<tr>
<td style="text-align:center">MSG_PEEK　　</td>
<td style="text-align:center">验证输入缓冲是否存在待接受的数据</td>
<td style="text-align:center">•</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">MSG_DONTROUTE</td>
<td style="text-align:center">绕过路由表查找，在本地网络中寻找目的地</td>
<td style="text-align:center"></td>
<td style="text-align:center">•</td>
</tr>
<tr>
<td style="text-align:center">MSG_DONTWAIT</td>
<td style="text-align:center">调用I/O函数时不阻塞，用于使用非阻塞I/O</td>
<td style="text-align:center">•</td>
<td style="text-align:center">•</td>
</tr>
<tr>
<td style="text-align:center">MSG_WAITALL　　</td>
<td style="text-align:center">防止函数返回，直到接受全部请求的字节数</td>
<td style="text-align:center">•</td>
</tr>
</tbody>
</table>
<p><strong>MSG_OOB选项：发送紧急消息</strong></p>
<ul>
<li>MSG_OOB可选项用于发送“带外数据”紧急消息。</li>
<li>示例:</li>
</ul>
<p>发送端：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">... 		<span class="comment">//头文件</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">recv_adr</span>;</span></span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	sock=socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">memset</span>(&amp;recv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_adr));</span><br><span class="line">	recv_adr.sin_family=AF_INET;</span><br><span class="line">	recv_adr.sin_addr.s_addr=inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">	recv_adr.sin_port=htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(connect(sock, (struct sockaddr*)&amp;recv_adr, <span class="keyword">sizeof</span>(recv_adr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"connect() error!"</span>);</span><br><span class="line">	</span><br><span class="line">	write(sock,<span class="string">"123"</span>,<span class="built_in">strlen</span>(<span class="string">"123"</span>));</span><br><span class="line">	send(sock,<span class="string">"4"</span>,<span class="built_in">strlen</span>(<span class="string">"4"</span>),MSG_OOB);  <span class="comment">//发送带外数据</span></span><br><span class="line">	write(sock,<span class="string">"567"</span>,<span class="built_in">strlen</span>(<span class="string">"567"</span>));</span><br><span class="line">	send(sock,<span class="string">"890"</span>,<span class="built_in">strlen</span>(<span class="string">"890"</span>),MSG_OOB);		<span class="comment">//发送带外数据</span></span><br><span class="line">	</span><br><span class="line">	close(sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接受端：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">...			<span class="comment">//头文件省略</span></span><br><span class="line"><span class="keyword">int</span> acpt_sock;</span><br><span class="line"><span class="keyword">int</span> recv_sock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">urg_handler</span><span class="params">(<span class="keyword">int</span> sig)</span>           <span class="comment">//带外数据处理函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> str_len;</span><br><span class="line">	<span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">	str_len=recv(recv_sock,buf,<span class="keyword">sizeof</span>(buf),MSG_OOB);</span><br><span class="line">	buf[str_len]=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Uegent message : %s \n"</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">recv_adr</span>, <span class="title">serv_adr</span>;</span></span><br><span class="line">	<span class="keyword">int</span> str_len, state;</span><br><span class="line">	<span class="keyword">socklen_t</span> serv_adr_sz;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">	<span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]); </span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	act.sa_handler = urg_handler;</span><br><span class="line">	sigemptyset(&amp;act.sa_mask);</span><br><span class="line">	act.sa_flags=<span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	acpt_sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;recv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(recv_adr));</span><br><span class="line">	recv_adr.sin_family=AF_INET;</span><br><span class="line">	recv_adr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">	recv_adr.sin_port=htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(bind(acpt_sock, (struct sockaddr*)&amp;recv_adr, <span class="keyword">sizeof</span>(recv_adr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">	listen(acpt_sock, <span class="number">5</span>);</span><br><span class="line">	serv_adr_sz=<span class="keyword">sizeof</span>(serv_adr);</span><br><span class="line">	recv_sock=accept(acpt_sock, (struct sockaddr*)&amp;serv_adr, &amp;serv_adr_sz);</span><br><span class="line">	</span><br><span class="line">	fcntl(recv_sock,F_SETOWN,getpid());     <span class="comment">//为带外数据指定处理进程</span></span><br><span class="line">	state=sigaction(SIGURG,&amp;act,<span class="number">0</span>);         <span class="comment">//为SIGURG信号注册函数</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>((str_len=recv(recv_sock,buf,<span class="keyword">sizeof</span>(buf),<span class="number">0</span>))!=<span class="number">0</span>)   <span class="comment">//正常读取普通数据</span></span><br><span class="line">	&#123;</span><br><span class="line">		buf[str_len]=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">puts</span>(buf);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	close(recv_sock);</span><br><span class="line">	close(acpt_sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>检查输入缓冲</strong></p>
<ul>
<li>设置MSG_PEEK选项并调用recv函数时，即使读取了输入缓冲中的数据也不会删除。因此该选项经常与MSG_DONTWAIT合作，用于调用以非阻塞方式验证待读数据的存在与否的函数。</li>
<li>示例:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">... 			<span class="comment">//头文件省略</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> acpt_sock, recv_sock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">acpt_adr</span>, <span class="title">recv_adr</span>;</span></span><br><span class="line">	<span class="keyword">int</span> str_len, state;</span><br><span class="line">	<span class="keyword">socklen_t</span> recv_adr_sz;</span><br><span class="line">	<span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	acpt_sock=socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">memset</span>(&amp;acpt_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(acpt_adr));</span><br><span class="line">	acpt_adr.sin_family=AF_INET;</span><br><span class="line">	acpt_adr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">	acpt_adr.sin_port=htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">	</span><br><span class="line">  	<span class="keyword">if</span>(bind(acpt_sock, (struct sockaddr*)&amp;acpt_adr, <span class="keyword">sizeof</span>(acpt_adr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">	listen(acpt_sock, <span class="number">5</span>);</span><br><span class="line">	</span><br><span class="line">	recv_adr_sz=<span class="keyword">sizeof</span>(recv_adr);</span><br><span class="line">	recv_sock=accept(acpt_sock, (struct sockaddr*)&amp;recv_adr, &amp;recv_adr_sz);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//查看缓冲是否有数据，读完 不会删除缓冲区</span></span><br><span class="line">		str_len=recv(recv_sock,buf,<span class="keyword">sizeof</span>(buf)<span class="number">-1</span>,MSG_PEEK|MSG_DONTWAIT); 		</span><br><span class="line">		<span class="keyword">if</span>(str_len&gt;<span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	buf[str_len]=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Buffering %d bytes: %s \n"</span>, str_len, buf);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//正常读取，读完删除</span></span><br><span class="line">	str_len = recv(recv_sock,buf,<span class="keyword">sizeof</span>(buf)<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">	buf[str_len]=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Readagin : %s \n"</span>,buf);</span><br><span class="line"></span><br><span class="line">	close(acpt_sock);</span><br><span class="line">	close(recv_sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-readv-amp-writev函数"><a href="#2-readv-amp-writev函数" class="headerlink" title="2. readv &amp; writev函数"></a>2. readv &amp; writev函数</h2><p>通过writev函数可以将分散保存在多个缓冲中的数据一并发送，通过readv函数可以由多个缓冲分别接受。</p>
<p><strong>writev函数</strong></p>
<ul>
<li>头文件：<code>&lt;sys/uio.h&gt;</code></li>
<li><p>原型：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> writev (<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>fd 表示数据传输对象的文件描述符</li>
<li>iov iov结构体数组的地址值</li>
<li>iovcnt 第二个参数的数组长度</li>
</ul>
</li>
<li>返回值：成功时返回 发送的字节数，失败返回-1</li>
<li><p>iovec结构体</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *iov_base;	<span class="comment">/* Pointer to data.  */</span></span><br><span class="line">    <span class="keyword">size_t</span> iov_len;	<span class="comment">/* Length of data.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line">	<span class="keyword">char</span> buf1[]=<span class="string">"ABCDEFG"</span>;</span><br><span class="line">	<span class="keyword">char</span> buf2[]=<span class="string">"1234567"</span>;</span><br><span class="line">	vec[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">	vec[<span class="number">0</span>].iov_len=<span class="number">3</span>;</span><br><span class="line">	vec[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">	vec[<span class="number">1</span>].iov_len=<span class="number">4</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> str_len=writev(<span class="number">1</span>,vec,<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\nWrite bytes: %d \n"</span>,str_len);	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>readv函数</strong></p>
<ul>
<li>头文件：<code>&lt;sys/uio.h&gt;</code></li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> readv (<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>fd 表示数据接收对象的文件描述符（或套接字）</li>
<li>iov iov结构体数组的地址值</li>
<li>iovcnt 第二个参数的数组长度</li>
</ul>
</li>
<li>示例:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line">	<span class="keyword">char</span> buf1[BUF_SIZE]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> buf2[BUF_SIZE]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	vec[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">	vec[<span class="number">0</span>].iov_len=<span class="number">5</span>;</span><br><span class="line">	vec[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">	vec[<span class="number">1</span>].iov_len=<span class="number">20</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> str_len = readv(<span class="number">0</span>,vec,<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Read bytes: %d \n"</span>,str_len);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"First message: %s \n"</span>, buf1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Second message: %s "</span>, buf2);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="第十四章-多播与广播"><a href="#第十四章-多播与广播" class="headerlink" title="第十四章 多播与广播"></a>第十四章 多播与广播</h1><h2 id="1-多播"><a href="#1-多播" class="headerlink" title="1. 多播"></a>1. 多播</h2><ul>
<li>多播方式的数据传输是基于UDP完成的。采用多播方式时，可以同时向多个主机传输数据。</li>
<li>多播组是D类IP地址,第1个字节的前四位固定为1110 , 范围：224.0.0.0~239.255.255.255</li>
<li>多播是借助路由器复制数据包完成的</li>
<li>TTL设置方法：通过设置套接字选项</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> recv_sock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">time_live</span> = 64;</span></span><br><span class="line">…………</span><br><span class="line">send_sock = socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">setopt(send_sock,IPPROTO_IP,IP_MULTICAST_TTL,(<span class="keyword">void</span>*)&amp;time_live,<span class="keyword">sizeof</span>(time_live));</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>
<ul>
<li>加入多播组的方法：通过设置套接字选项</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> recv_sock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">join_adr</span>;</span></span><br><span class="line">…………</span><br><span class="line">recv_sock = socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">…………</span><br><span class="line">join_adr.imr_multiaddr.s_addr=<span class="string">"&lt;多播组地址信息&gt;"</span>;</span><br><span class="line">join_adr.imr_interface.s_addr=<span class="string">"&lt;加入多播组的主机地址信息&gt;"</span>;</span><br><span class="line">setsockopt(recv_sock,IPPROTO_IP,IP_ADD_MEMBERSHIP,(<span class="keyword">void</span>*) &amp;join_adr,<span class="keyword">sizeof</span>(join_adr));</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>
<h2 id="2-广播"><a href="#2-广播" class="headerlink" title="2. 广播"></a>2. 广播</h2><ul>
<li>广播也是基于UDP完成的</li>
<li>广播分为两种：直接广播和本地广播。</li>
<li>直接广播的IP地址中除了网络地址外，其余主机地址全部为1。可以采用直接广播的方式向特定区域内的所有字节传输数据。</li>
<li>本地广播的IP地址限定为255.255.255.255。</li>
<li>设置允许进行数据广播<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> send_sock;</span><br><span class="line"><span class="keyword">int</span> bast = <span class="number">1</span>;</span><br><span class="line">…………</span><br><span class="line">send_sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">…………</span><br><span class="line">setsockopt(send_sock,SOL_SOCKET,SO_BROADCAST,(<span class="keyword">void</span> *)&amp;bast,<span class="keyword">sizeof</span>(bast));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="第二十四章-制作HTTP服务器端"><a href="#第二十四章-制作HTTP服务器端" class="headerlink" title="第二十四章 制作HTTP服务器端"></a>第二十四章 制作HTTP服务器端</h1><ul>
<li>HTTP，Hypertext Transfer Protocol, 超文本传输协议，基于TCP/IP实现的以超文本传输为目的的应用层协议。</li>
<li>HTTP协议是无状态的协议，服务端响应客户端后立即断开连接</li>
<li>状态码：表示客户端请求的执行结果<ul>
<li>200 OK：成功处理了请求</li>
<li>404 Not Found：请求的文件不存在</li>
<li>400 Bad Request：错误的请求</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/06/tcpip复习总结(1)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Keaper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Keaper's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/06/tcpip复习总结(1)/" itemprop="url">
                  TCP/IP网络编程复习总结(1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-06-06 13:23:00" itemprop="dateCreated datePublished" datetime="2017-06-06T13:23:00+00:00">2017-06-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-08 14:04:51" itemprop="dateModified" datetime="2019-03-08T14:04:51+00:00">2019-03-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一章-理解网络编程和套接字"><a href="#第一章-理解网络编程和套接字" class="headerlink" title="第一章 理解网络编程和套接字"></a>第一章 理解网络编程和套接字</h1><h2 id="1-理解网络编程和套接字"><a href="#1-理解网络编程和套接字" class="headerlink" title="1. 理解网络编程和套接字"></a>1. 理解网络编程和套接字</h2><ul>
<li>网络编程就是编写程序使得两台计算机相互交换数据。</li>
<li>套接字是网络传输所用的软件设备。</li>
</ul>
<h2 id="2-基于linux的文件操作"><a href="#2-基于linux的文件操作" class="headerlink" title="2. 基于linux的文件操作"></a>2. 基于linux的文件操作</h2><ul>
<li>对于linux而言，socket操作和文件操作没有区别。socket也被认为是文件的一种，因此在网络数据传输过程中可以使用文件I/O的相关函数。而Windows是区分socket与文件的。</li>
<li>文件描述符：系统分配给文件或套接字的一个整数，用以标识文件或者套接字。    </li>
<li>标准输出输出以及标准错误文件描述符：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">对象</th>
<th style="text-align:center">文件描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">标准输入：stdin</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">标准输出：stdout</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">标准错误：stderr</td>
<td style="text-align:center">2</td>
</tr>
</tbody>
</table>
<h2 id="3-文件操作"><a href="#3-文件操作" class="headerlink" title="3. 文件操作"></a>3. 文件操作</h2><p><strong>打开文件open()</strong></p>
<ul>
<li>头文件：<code>&lt;sys/types.h&gt;</code>,<code>&lt;sys/stat.h&gt;</code>, <code>&lt;fcntl.h&gt;</code><br><em>注：文件的打开模式定义在头文件<code>&lt;sys/stat.h&gt;</code>中，<code>&lt;sys/types.h&gt;</code>中定义了各种数据类型，open()函数定义在<code>&lt;fcntl.h&gt;</code>头文件中。</em></li>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> str * path, <span class="keyword">int</span> flag)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回值：成功则返回文件描述符，出错返回-1 </p>
</li>
<li>参数：<ul>
<li>path: 打开或创建的文件的路径名 </li>
<li>flag：文件打开模式信息</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">打开模式</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">O_CREAT</td>
<td style="text-align:center">必要时创建文件</td>
</tr>
<tr>
<td style="text-align:center">O_TRUNC</td>
<td style="text-align:center">删除全部现有数据</td>
</tr>
<tr>
<td style="text-align:center">O_APPEND</td>
<td style="text-align:center">维持现有数据，白村到其后面</td>
</tr>
<tr>
<td style="text-align:center">O_RDONLY</td>
<td style="text-align:center">只读打开</td>
</tr>
<tr>
<td style="text-align:center">O_WRONLY</td>
<td style="text-align:center">只写打开</td>
</tr>
<tr>
<td style="text-align:center">O_RDWR</td>
<td style="text-align:center">读写打开</td>
</tr>
</tbody>
</table>
<p><strong>关闭文件close()</strong></p>
<ul>
<li>需要包含的头文件：<code>&lt;unistd.h&gt;</code></li>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>fd:需要关闭文件的文件描述符</li>
</ul>
</li>
</ul>
<p><strong>读取文件中的数据read()</strong></p>
<ul>
<li>需要包含的头文件：<code>&lt;unistd.h&gt;</code></li>
<li><p>函数原型：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> * buf, <span class="keyword">size_t</span> nbytes);</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回值：成功时返回实际读到的字节数；已读到文件尾返回0，出错的话返回-1。</p>
</li>
<li>参数：<ul>
<li>fd：要读取的文件的描述符<ul>
<li>buf：得到的数据在内存中的位置的首地址</li>
<li>nbytes：要接受数据的最大字节数</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>向文件中写数据write()</strong></p>
<ul>
<li>需要包含的头文件：<code>&lt;unistd.h&gt;</code></li>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> * buf, <span class="keyword">size_t</span> nbytes);</span><br></pre></td></tr></table></figure>
</li>
<li><p>功能：向打开的文件写数据</p>
</li>
<li>返回值：写入成功返回实际写入的字节数，出错返回-1</li>
<li>参数：<ul>
<li>fd：要写入文件的文件描述符</li>
<li>buf：要写入文件的数据在内存中存放位置的首地址</li>
<li>nbytes：要传输数据的最大字节数</li>
</ul>
</li>
<li>样例代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">char</span> buf[]=<span class="string">"Hello World!"</span>;</span><br><span class="line">	</span><br><span class="line">	fd=open(<span class="string">"data.txt"</span>,O_CREAT|O_WRONLY|O_TRUNC); 	<span class="comment">//打开文件</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"File descriptor : %d \n"</span>,fd);</span><br><span class="line"></span><br><span class="line">	write(fd,buf,<span class="keyword">sizeof</span>(buf));	<span class="comment">//写数据</span></span><br><span class="line">	close(fd);					<span class="comment">//关闭文件</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">	</span><br><span class="line">	fd=open(<span class="string">"data.txt"</span>,O_RDONLY);		<span class="comment">//打开文件</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"File descriptor: %d \n"</span> , fd);</span><br><span class="line">	</span><br><span class="line">	read(fd,buf,<span class="keyword">sizeof</span>(buf));			<span class="comment">//读数据</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"File data: %s\n"</span>,buf);</span><br><span class="line"></span><br><span class="line">	close(fd);			<span class="comment">//关闭文件</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="第二章-套接字类型与协议设置"><a href="#第二章-套接字类型与协议设置" class="headerlink" title="第二章 套接字类型与协议设置"></a>第二章 套接字类型与协议设置</h1><h2 id="1-创建套接字socket"><a href="#1-创建套接字socket" class="headerlink" title="1. 创建套接字socket()"></a>1. 创建套接字socket()</h2><ul>
<li>需要包含的头文件 &lt;sys/socket.h&gt;</li>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回值：成功：文件描述符；否则：-1。</p>
</li>
<li>参数：<ul>
<li>domain：套接字所使用的协议族</li>
<li>type：套接字数据传输类型</li>
<li>protocol：套接字所使用的协议</li>
</ul>
</li>
</ul>
<h2 id="2-参数domain-常用协议族"><a href="#2-参数domain-常用协议族" class="headerlink" title="2. 参数domain:常用协议族"></a>2. 参数domain:常用协议族</h2><table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">协议族</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PF_INET</td>
<td style="text-align:center">IPv4互联网协议族</td>
</tr>
<tr>
<td style="text-align:center">PF_INET6</td>
<td style="text-align:center">IPv46互联网协议族</td>
</tr>
<tr>
<td style="text-align:center">PF_LOCAL</td>
<td style="text-align:center">本地通信的UNIX协议族</td>
</tr>
</tbody>
</table>
<h2 id="3-参数type-套接字类型"><a href="#3-参数type-套接字类型" class="headerlink" title="3. 参数type:套接字类型"></a>3. 参数type:套接字类型</h2><ul>
<li><p>类型1：面向连接的套接字（SOCK_STREAM）<br><strong>可靠、按序传递的、基于字节的面向连接的套接字。</strong></p>
<ul>
<li>传输过程中数据不会消失：错误重传</li>
<li>按序传输数据：按发送顺序放入buffer</li>
<li>传输的数据不存在数据边界</li>
<li>面向连接的套接字只能与另外一个同样特性的套接字连接，一一对应</li>
</ul>
</li>
<li><p>类型2：面向消息的套接字（SOCK_DGRAM）<br><strong>不可靠的、不按序传递、以数据的高速传输为目的的套接字。</strong></p>
<ul>
<li>快速传输而非传输顺序</li>
<li>传输的数据可能丢失也可能损毁</li>
<li>传输的数据有边界</li>
<li>每次传输的数据大小有限</li>
</ul>
</li>
</ul>
<h2 id="4-参数protocol-协议类型"><a href="#4-参数protocol-协议类型" class="headerlink" title="4. 参数protocol:协议类型"></a>4. 参数protocol:协议类型</h2><ul>
<li><p>如果一个协议族中存在多种数据传输方式，该参数用以确定最终采用的协议。如果前两个参数已唯一确定，这个参数传0即可。</p>
</li>
<li><p>创建TCP套接字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_socket = socket(PF_INET,SOCKET_STREAM,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">int</span> tcp_socket = socket(PF_INET,SOCKET_STREAM,IPPROTO_TCP);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建UDP套接字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_socket = socket(PF_INET,SOCKET_DGRAM,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">int</span> tcp_socket = socket(PF_INET,SOCKET_DGRAM,IPPROTO_UDP);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="第三章-地址族与数据序列"><a href="#第三章-地址族与数据序列" class="headerlink" title="第三章 地址族与数据序列"></a>第三章 地址族与数据序列</h1><h2 id="1-IP地址与端口号"><a href="#1-IP地址与端口号" class="headerlink" title="1. IP地址与端口号"></a>1. IP地址与端口号</h2><ul>
<li>IPv4的地址有4字节，32位。</li>
<li>端口号有16位构成，范围为0～65535。</li>
<li>端口号就是为了在同一个操作系统内区分不同套接字而设置的，无法将一个端口号分配给不同的套接字。</li>
</ul>
<h2 id="2-地址信息的表示"><a href="#2-地址信息的表示" class="headerlink" title="2. 地址信息的表示"></a>2. 地址信息的表示</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">sa_family_t</span>     sin_family;</span><br><span class="line">	<span class="keyword">uint16_t</span>        sin_port;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span>  <span class="title">sin_addr</span>;</span></span><br><span class="line">	<span class="keyword">char</span>            sin_zero[<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="1-成员sin-family"><a href="#1-成员sin-family" class="headerlink" title="(1) 成员sin_family"></a>(1) 成员sin_family</h3><p>地址族，每种协议族适用的地址族均不同。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">地址族</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">AF_INET</td>
<td style="text-align:center">IPv4网络协议使用的地址族</td>
</tr>
<tr>
<td style="text-align:center">AF_INET6</td>
<td style="text-align:center">IPv6网络协议使用的地址族</td>
</tr>
<tr>
<td style="text-align:center">AF_LOCAL</td>
<td style="text-align:center">本地通信中采用的UNIX协议的地址族</td>
</tr>
</tbody>
</table>
<h3 id="2-成员sin-port"><a href="#2-成员sin-port" class="headerlink" title="(2) 成员sin_port"></a>(2) 成员sin_port</h3><p>16位端口号，以网络字节序保存。</p>
<h3 id="3-成员sin-addr"><a href="#3-成员sin-addr" class="headerlink" title="(3) 成员sin_addr"></a>(3) 成员sin_addr</h3><p>保存32位地址信息，以网络字节序保存。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">in_addr_t</span> s_addr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-成员sin-zero"><a href="#4-成员sin-zero" class="headerlink" title="(4) 成员sin_zero"></a>(4) 成员sin_zero</h3><p>无特殊含义，是为了使sockaddr_in的大小与sockaddr结构体的大小一致而插入的，必须填充为0.</p>
<h2 id="3-sockaddr-in结构体的使用"><a href="#3-sockaddr-in结构体的使用" class="headerlink" title="3. sockaddr_in结构体的使用"></a>3. sockaddr_in结构体的使用</h2><p>bind函数原型：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind(<span class="keyword">int</span> sockfd, struct sockaddr *myaddr, <span class="keyword">socklen_t</span> addrlen);</span><br></pre></td></tr></table></figure></p>
<p>第二个参数接期望得到一个sockaddr结构体变量地址值。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">sa_family_t</span>     sin_family; </span><br><span class="line">	<span class="keyword">char</span> sa_data[<span class="number">14</span>];				<span class="comment">/* Address data.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>所以使用时要将sockaddr_in结构体变量的地址转换位sockaddr结构体变量的指针，然后再传递给bind函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>;</span></span><br><span class="line">…………</span><br><span class="line"><span class="keyword">if</span>(bind(serv_sock, (struct sockaddr*) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>); </span><br><span class="line">…………</span><br></pre></td></tr></table></figure></p>
<h2 id="4-网络字节序与地址变换"><a href="#4-网络字节序与地址变换" class="headerlink" title="4. 网络字节序与地址变换"></a>4. 网络字节序与地址变换</h2><ul>
<li>字节序有大端小端之分。<ul>
<li>大端模式，是指数据的高字节保存在内存的低地址中，而数据的低字节保存在内存的高地址中。</li>
<li>小端模式，是指数据的高字节保存在内存的高地址中，而数据的低字节保存在内存的低地址中。</li>
</ul>
</li>
<li>网络字节序统一为大端方式。所以传输之前应该进行字节序转换。</li>
<li><p>为了进行转换socket提供了转换的函数有下面四个:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;			\\头文件</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">htons</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span>)</span></span>; 	\\把<span class="keyword">unsigned</span> <span class="keyword">short</span>类型从主机序转换到网络序</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">ntohs</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span>)</span></span>; 	\\把<span class="keyword">unsigned</span> <span class="keyword">short</span>类型从网络序转换到主机序</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">htonl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>; 	\\把<span class="keyword">unsigned</span> <span class="keyword">long</span>类型从主机序转换到网络序</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">ntohl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;	\\把<span class="keyword">unsigned</span> <span class="keyword">long</span>类型从网络序转换到主机序</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例：</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> host_port=<span class="number">0x1234</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> net_port;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> host_addr=<span class="number">0x12345678</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> net_addr;</span><br><span class="line">	</span><br><span class="line">	net_port = htons(host_port);</span><br><span class="line">	net_addr = htons(host_addr);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Host ordered port: %#x \n"</span>, host_port);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Network ordered port: %#x \n"</span>, net_port);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Host ordered address: %#lx \n"</span>, host_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Network ordered address: %#lx \n"</span>, net_addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Host ordered port: 0x1234 </span></span><br><span class="line"><span class="comment">Network ordered port: 0x3412 </span></span><br><span class="line"><span class="comment">Host ordered address: 0x12345678 </span></span><br><span class="line"><span class="comment">Network ordered address: 0x7856</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h2 id="5-网络地址的初始化与分配"><a href="#5-网络地址的初始化与分配" class="headerlink" title="5. 网络地址的初始化与分配"></a>5. 网络地址的初始化与分配</h2><h3 id="1-将字符串信息转换为网络字节序的整数型值"><a href="#1-将字符串信息转换为网络字节序的整数型值" class="headerlink" title="(1) 将字符串信息转换为网络字节序的整数型值"></a>(1) 将字符串信息转换为网络字节序的整数型值</h3><p><strong>inet_addr()函数</strong></p>
<ul>
<li>头文件：&lt;arpa/inet.h&gt;</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">in_addr_t</span> inet_addr (<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：点分十进制格式的IP地址字符串</p>
</li>
<li>返回值： 成功返回32位大端序整数型值，失败返回INADDR_NONE。</li>
</ul>
<p><strong>inet_aton()函数</strong></p>
<ul>
<li>头文件：&lt;arpa/inet.h&gt;</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_aton</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * <span class="built_in">string</span>, struct in_addr *addr)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>string—点分十进制格式的IP地址字符串</li>
<li>addr—保存转换结果的in_addr结构体变量的地址值。</li>
</ul>
</li>
<li>返回值：成功返回1，失败返回0</li>
</ul>
<p><strong>inet_ntoa()函数</strong> </p>
<ul>
<li>头文件：&lt;arpa/inet.h&gt;</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">inet_ntoa</span> <span class="params">(struct in_addr adr)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：需要转换的in_addr结构体</p>
</li>
<li>返回值：成功时返回转换的字符串地址值，失败返回-1</li>
</ul>
<p><strong>示例代码:</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *addr1=<span class="string">"1.2.3.4"</span>;</span><br><span class="line">	<span class="keyword">char</span> *addr2=<span class="string">"127.212.124.256"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> conv_addr = inet_addr(addr1);</span><br><span class="line">	<span class="keyword">if</span>(conv_addr==INADDR_NONE)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Error occured! \n"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#lx \n"</span>, conv_addr);</span><br><span class="line">	</span><br><span class="line">	conv_addr = inet_addr(addr2);</span><br><span class="line">	<span class="keyword">if</span>(conv_addr==INADDR_NONE)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Error occureded \n"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#lx \n\n"</span>, conv_addr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Network ordered integer addr: 0x4030201 </span></span><br><span class="line"><span class="comment">Error occureded</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> * addr = <span class="string">"1.2.3.4"</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr_inet</span>;</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(!inet_aton(addr,&amp;addr_inet.sin_addr))</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Conversion error"</span>);</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#x \n"</span>,addr_inet.sin_addr.s_addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Network ordered integer addr: 0x4030201</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">	<span class="keyword">char</span> * str_ptr;</span><br><span class="line">	addr.sin_addr.s_addr = htonl(<span class="number">0x1020304</span>);</span><br><span class="line">	str_ptr= inet_ntoa(addr.sin_addr);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Dotted-Decimal notation: %s \n"</span>,str_ptr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Dotted-Decimal notation: 1.2.3.4 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="2-常见的套接字创建过程中网络地址信息初始化方法"><a href="#2-常见的套接字创建过程中网络地址信息初始化方法" class="headerlink" title="(2) 常见的套接字创建过程中网络地址信息初始化方法"></a>(2) 常见的套接字创建过程中网络地址信息初始化方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct sockaddr_in addr;</span><br><span class="line">char * serv_ip =&quot;211.217.168.13&quot;;</span><br><span class="line">char * serv_port = &quot;9190&quot;;</span><br><span class="line">memset(&amp;addr, 0, sizeof(addr));</span><br><span class="line">addr.sin_family=AF_INET;</span><br><span class="line">addr.sin_addr.s_addr=htonl(serv_ip);</span><br><span class="line">addr.sin_port=htons(atoi(serv_port));</span><br></pre></td></tr></table></figure>
<p>可以利用INADDR_ANY常量分配服务端IP地址，自动获取本机IP。</p>
<h3 id="3-向套接字分配网络地址-bind-函数"><a href="#3-向套接字分配网络地址-bind-函数" class="headerlink" title="(3) 向套接字分配网络地址 bind()函数"></a>(3) 向套接字分配网络地址 bind()函数</h3><ul>
<li>功能：<br>  bind函数将socket与网络地址信息绑定。</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span> <span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *myaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sockfd—要分配地址信息的套接字文件描述符</li>
<li>myaddr—存有地址信息的sockaddr结构体变量的地址值。</li>
<li>addrlen—第二个结构体变量的长度</li>
</ul>
</li>
<li>返回值：<br>  成功返回0，失败返回-1</li>
</ul>
<h1 id="第四、五章-基于TCP的服务端-客户端"><a href="#第四、五章-基于TCP的服务端-客户端" class="headerlink" title="第四、五章 基于TCP的服务端/客户端"></a>第四、五章 基于TCP的服务端/客户端</h1><h2 id="1-TCP服务器端的默认函数调用顺序"><a href="#1-TCP服务器端的默认函数调用顺序" class="headerlink" title="1. TCP服务器端的默认函数调用顺序"></a>1. TCP服务器端的默认函数调用顺序</h2><ul>
<li>socket() 创建套接字</li>
<li>bind() 分配给套接字地址</li>
<li>listen() 等待连接请求状态</li>
<li>accept() 允许连接，接收新连接</li>
<li>read()/write() 数据交换</li>
<li>close() 关闭套接字，断开连接</li>
</ul>
<h2 id="2-进入等待连接请求状态-listen-函数"><a href="#2-进入等待连接请求状态-listen-函数" class="headerlink" title="2. 进入等待连接请求状态 listen()函数"></a>2. 进入等待连接请求状态 listen()函数</h2><ul>
<li>功能：<br>  进入等待连接请求状态</li>
<li><p>原型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen(int sock, int backlog);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock—希望进入等待连接请求状态的套接字文件描述符，该套接字将变为服务端套接字即监听套接字。</li>
<li>backlog—连接请求等待队列的长度。</li>
</ul>
</li>
<li>返回值：<br>  成功返回0，失败返回-1</li>
</ul>
<h2 id="3-受理客户端连接请求-connect-函数"><a href="#3-受理客户端连接请求-connect-函数" class="headerlink" title="3. 受理客户端连接请求 connect()函数"></a>3. 受理客户端连接请求 connect()函数</h2><ul>
<li>功能：接受客户端连接请求</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span> <span class="params">(<span class="keyword">int</span> sock, struct sockaddr * addr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock—服务端套接字文件描述符</li>
<li>addr—保存发起连接请求的客户端地址信息的变量地址值，函数调用完成后，该地址保存的是客户端地址信息</li>
<li>addrlen—保存第二个参数sockaddr结构体的长度，函数调用完成后，该地址保存的客户端地址信息的长度</li>
</ul>
</li>
<li>返回值：成功时返回创建的套接字文件描述符，用以数据交换，失败时返回-1</li>
</ul>
<h2 id="4-TCP客户端的默认函数调用顺序"><a href="#4-TCP客户端的默认函数调用顺序" class="headerlink" title="4. TCP客户端的默认函数调用顺序"></a>4. TCP客户端的默认函数调用顺序</h2><ul>
<li>socket() 创建套接字</li>
<li>connect() 请求连接</li>
<li>read()/write() 数据交换</li>
<li>close() 关闭套接字，断开连接</li>
</ul>
<h2 id="5-客户端发起连接请求connect-函数"><a href="#5-客户端发起连接请求connect-函数" class="headerlink" title="5. 客户端发起连接请求connect()函数"></a>5. 客户端发起连接请求connect()函数</h2><ul>
<li>功能：<br>  请求连接到服务器</li>
<li><p>原型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int connect(int sock, struct sockaddr * servaddr, socklen_t addrlen);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock—客户端套接字文件描述符</li>
<li>servaddr—存有目标服务器端地址信息的变量地址值</li>
<li>addrlen—第二个参数sockaddr结构体的长度</li>
</ul>
</li>
<li><p>客户端调用connect函数后，发生一下情况之一才会返回：</p>
</li>
</ul>
<ol>
<li>服务端接受连接请求。</li>
<li>发生断网等异常情况而中断连接请求。</li>
</ol>
<ul>
<li>注：客户端的IP地址和端口号在调用connect函数是自动分配。</li>
</ul>
<h2 id="6-第一个基于TCP的服务端-客户端—HelloWorld服务器"><a href="#6-第一个基于TCP的服务端-客户端—HelloWorld服务器" class="headerlink" title="6. 第一个基于TCP的服务端/客户端—HelloWorld服务器"></a>6. 第一个基于TCP的服务端/客户端—HelloWorld服务器</h2><p>服务端代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">//错误处理</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">	fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//定义套接字</span></span><br><span class="line">	<span class="keyword">int</span> serv_sock; <span class="comment">//用于监听的套接字</span></span><br><span class="line">	<span class="keyword">int</span> clnt_sock; <span class="comment">//用于数据传输的套接字</span></span><br><span class="line">	<span class="comment">//定义地址信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>;</span> <span class="comment">//服务端地址信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clnt_addr</span>;</span> <span class="comment">//请求连接的客户端地址信息</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clnt_addr_size;	<span class="comment">//客户端地址信息长度</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> message[]=<span class="string">"Hello World!"</span>;</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	serv_sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(serv_sock == <span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line">	<span class="comment">//地址信息初始化</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">	serv_addr.sin_family = AF_INET;</span><br><span class="line">	serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">	serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">	<span class="comment">//绑定地址信息</span></span><br><span class="line">		<span class="comment">//需要将sockaddr_in结构体变量地址强制转换为sockaddr结构体类型指针</span></span><br><span class="line">	<span class="keyword">if</span>(bind(serv_sock,(struct sockaddr*) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>) </span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(listen(serv_sock,<span class="number">5</span>)==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"liste() error"</span>);</span><br><span class="line">	<span class="comment">//接受客户端连接请求</span></span><br><span class="line">		<span class="comment">//需要将sockaddr_in结构体变量地址强制转换为sockaddr结构体类型指针</span></span><br><span class="line">	clnt_addr_size = <span class="keyword">sizeof</span>(clnt_addr);</span><br><span class="line">	clnt_sock = accept(serv_sock,(struct sockaddr*) &amp;clnt_addr,&amp;clnt_addr_size);</span><br><span class="line">	<span class="keyword">if</span>(clnt_sock == <span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"accept() error"</span>);</span><br><span class="line">	<span class="comment">//向客户端发送一句“Hello World!”</span></span><br><span class="line">	write(clnt_sock,message,<span class="keyword">sizeof</span>(message));</span><br><span class="line">	<span class="comment">//关闭数据交换套接字</span></span><br><span class="line">	close(clnt_sock);</span><br><span class="line">	<span class="comment">//关闭监听套接字</span></span><br><span class="line">	close(serv_sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>客户端<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> * message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(message,<span class="built_in">stderr</span>);</span><br><span class="line">	fputc(<span class="string">'\n'</span>,<span class="built_in">stderr</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//定义套接字</span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="comment">//定义服务端地址信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>;</span></span><br><span class="line">	<span class="comment">//存放接受的消息</span></span><br><span class="line">	<span class="keyword">char</span> message[<span class="number">30</span>];</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(sock==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line">	<span class="comment">//服务端地址信息初始化</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">	serv_addr.sin_family = AF_INET;</span><br><span class="line">	serv_addr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">	serv_addr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line">	<span class="comment">//请求连接服务端</span></span><br><span class="line">		<span class="comment">//需要将sockaddr_in结构体变量地址强制转换为sockaddr结构体类型指针</span></span><br><span class="line">	<span class="keyword">if</span>(connect(sock,(struct sockaddr *) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"conect() error!"</span>);</span><br><span class="line">	<span class="comment">//接受服务端发送的信息</span></span><br><span class="line">	<span class="keyword">int</span> str_len = read(sock,message,<span class="keyword">sizeof</span>(message)<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span>(str_len == <span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"read() error!"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Message from server : %s \n"</span>,message);</span><br><span class="line">	<span class="comment">//关闭套接字</span></span><br><span class="line">	close(sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="7-基于TCP的服务端客户端函数调用关系"><a href="#7-基于TCP的服务端客户端函数调用关系" class="headerlink" title="7. 基于TCP的服务端客户端函数调用关系"></a>7. 基于TCP的服务端客户端函数调用关系</h2><p>服务端创建套接字后连续调用bind(),listen()函数进入等待状态，客户端创建套接字后通过connect()发起连接请求。服务端调用accept(),接受一个连接请求，接受之后客户端connect函数返回，双方进入数据交换阶段，如果队列中没有连接请求，则进入阻塞状态。数据交换阶段，通过调用read()/write()函数交换数据。结束之后调用close()关闭套接字，断开连接。</p>
<h2 id="8-迭代服务端-客户端"><a href="#8-迭代服务端-客户端" class="headerlink" title="8. 迭代服务端/客户端"></a>8. 迭代服务端/客户端</h2><h3 id="1-迭代服务端函数调用顺序"><a href="#1-迭代服务端函数调用顺序" class="headerlink" title="(1) 迭代服务端函数调用顺序"></a>(1) 迭代服务端函数调用顺序</h3><p>重复调用accept函数以实现可以向多个客户端提供服务但是统一时刻还是只能为一个客户端提供服务，与一个客户端通信是其他客户端只能阻塞。</p>
<h3 id="2-迭代的回声服务端-客户端"><a href="#2-迭代的回声服务端-客户端" class="headerlink" title="(2) 迭代的回声服务端/客户端"></a>(2) 迭代的回声服务端/客户端</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">…………</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		clnt_sock=accept(serv_sock, (struct sockaddr*)&amp;clnt_adr, &amp;clnt_adr_sz);</span><br><span class="line">		<span class="keyword">if</span>(clnt_sock==<span class="number">-1</span>)</span><br><span class="line">			error_handling(<span class="string">"accept() error"</span>);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Connected client %d \n"</span>, i+<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">while</span>((str_len=read(clnt_sock, message, BUF_SIZE))!=<span class="number">0</span>)</span><br><span class="line">			write(clnt_sock, message, str_len);</span><br><span class="line"></span><br><span class="line">		close(clnt_sock);</span><br><span class="line">	&#125;</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>
<h2 id="9-解决TCP不存在数据边界的问题"><a href="#9-解决TCP不存在数据边界的问题" class="headerlink" title="9. 解决TCP不存在数据边界的问题"></a>9. 解决TCP不存在数据边界的问题</h2><p>自定义应用层协议</p>
<h2 id="10-TCP原理"><a href="#10-TCP原理" class="headerlink" title="10. TCP原理"></a>10. TCP原理</h2><h3 id="1-I-O缓冲"><a href="#1-I-O缓冲" class="headerlink" title="(1) I/O缓冲"></a>(1) I/O缓冲</h3><ul>
<li>I/O缓冲在每个TCP套接字中单独存在</li>
<li>I/O缓冲在创建套接字时自动生成</li>
<li>即使关闭套接字也会继续传递输出缓冲中遗留的数据</li>
<li>关闭套接字将丢失输入缓冲中的数据</li>
</ul>
<h3 id="2-套接字的连接"><a href="#2-套接字的连接" class="headerlink" title="(2) 套接字的连接"></a>(2) 套接字的连接</h3><p>三次握手</p>
<p><strong>套接字是以全双工的方式工作的，也就是说，它可以双向传递数据。</strong></p>
<h3 id="3-数据交换"><a href="#3-数据交换" class="headerlink" title="(3) 数据交换"></a>(3) 数据交换</h3><h3 id="4-断开套接字连接"><a href="#4-断开套接字连接" class="headerlink" title="(4) 断开套接字连接"></a>(4) 断开套接字连接</h3><p>四次挥手</p>
<h1 id="第六章-基于UDP的服务端-客户端"><a href="#第六章-基于UDP的服务端-客户端" class="headerlink" title="第六章 基于UDP的服务端/客户端"></a>第六章 基于UDP的服务端/客户端</h1><h2 id="1-UDP协议"><a href="#1-UDP协议" class="headerlink" title="1. UDP协议"></a>1. UDP协议</h2><ul>
<li>TCP比UDP慢的原因<ul>
<li>收发数据前后需要进行连接和清除过程</li>
<li>收发数据过程中需要添加流控制, 以保证数据可靠性</li>
</ul>
</li>
<li>UDP的高效使用<ul>
<li>如果数据完整性要求高, 使用TCP, 例如传送压缩的数据</li>
<li>如果可以容忍少量数据丢失, 使用UDP, 例如视频音频</li>
</ul>
</li>
</ul>
<h2 id="2-实现基于UDP的服务端-客户端"><a href="#2-实现基于UDP的服务端-客户端" class="headerlink" title="2. 实现基于UDP的服务端/客户端"></a>2. 实现基于UDP的服务端/客户端</h2><ul>
<li>UDP服务端和客户端没有连接<ul>
<li>不是面向连接的, 不需要连接过程</li>
<li>只需创建套接字, 然后进行数据交换, 不需要listen和accept</li>
</ul>
</li>
<li>UDP服务端和客户端均只需一个套接字<ul>
<li>TCP: 用于连接的套接字,以及数据交换的套接字(将保持连接)</li>
<li>UDP: 只需一个套接字(每次交换数据是需要添加目标地址信息)</li>
</ul>
</li>
</ul>
<h2 id="3-基于UDP的数据I-O函数"><a href="#3-基于UDP的数据I-O函数" class="headerlink" title="3. 基于UDP的数据I/O函数"></a>3. 基于UDP的数据I/O函数</h2><p><strong>sendto函数</strong></p>
<ul>
<li>功能：<br>  发送数据到对端</li>
<li><p>原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> sendto (<span class="keyword">int</span> sock, <span class="keyword">const</span> <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes,</span><br><span class="line">		       <span class="keyword">int</span> flags, struct sockaddr *to,<span class="keyword">socklen_t</span> addrlen);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock—用于传输数据的套接字文件描述符</li>
<li>buff—存有待传送数据的缓冲地址值</li>
<li>nbytes—待传输数据长度</li>
<li>flags—可选参数，若没有传递0</li>
<li>to—存有目标地址信息的sockaddr结构体变量的地址值</li>
<li>addrlen—参数to的地址值结构体变量长度</li>
</ul>
</li>
</ul>
<p><strong>recvfrom函数</strong></p>
<ul>
<li>功能：<br>  接收对端数据</li>
<li><p>原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> recvfrom (<span class="keyword">int</span> sock, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes,</span><br><span class="line">			 <span class="keyword">int</span> flags, struct sockaddr * from,<span class="keyword">socklen_t</span> *addrlen);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock—用于接受数据的套接字文件描述符</li>
<li>buff—用于保存接收数据的缓冲地址值</li>
<li>nbytes—可接收的最大字节数</li>
<li>flags—可选参数</li>
<li>from—存有发送端地址信息的sockaddr结构体变量的地址值</li>
<li>addrlen—参数法from的地址值结构体变量长度</li>
</ul>
</li>
</ul>
<p><strong>基于UDP的回声服务端/客户端:</strong></p>
<p>服务端<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> * message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(message,<span class="built_in">stderr</span>);</span><br><span class="line">	fputc(<span class="string">'\n'</span>,<span class="built_in">stderr</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> serv_sock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>,<span class="title">clnt_addr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clnt_addr_size;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	serv_sock=socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(serv_sock==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"UDP socket() error"</span>);</span><br><span class="line">	<span class="comment">//初始化地址信息</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">	serv_addr.sin_family=AF_INET;</span><br><span class="line">	serv_addr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">	serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">	<span class="comment">//绑定地址信息</span></span><br><span class="line">	<span class="keyword">if</span>(bind(serv_sock,(struct sockaddr *) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr))==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">	<span class="comment">//读写数据</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		clnt_addr_size = <span class="keyword">sizeof</span>(clnt_addr);</span><br><span class="line">		<span class="keyword">int</span> str_len = recvfrom(serv_sock,message,<span class="keyword">sizeof</span>(message),</span><br><span class="line">				<span class="number">0</span>,(struct sockaddr *) &amp;clnt_addr,&amp;clnt_addr_size);</span><br><span class="line">		sendto(serv_sock,message,str_len,</span><br><span class="line">				<span class="number">0</span>,(struct sockaddr *) &amp;clnt_addr,clnt_addr_size);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭套接字</span></span><br><span class="line">	close(serv_sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>客户端<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">	fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addr_size;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc!=<span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	sock = socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(sock==<span class="number">-1</span>)</span><br><span class="line">		error_handling(<span class="string">"socket() error"</span>);</span><br><span class="line">	<span class="comment">//初始化服务器地址信息</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;serv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">	serv_addr.sin_family=AF_INET;</span><br><span class="line">	serv_addr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">	serv_addr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line">	<span class="comment">//数据交换</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fputs</span>(<span class="string">"Insert message(q to quit): "</span>,<span class="built_in">stdout</span>);</span><br><span class="line">		fgets(message, <span class="keyword">sizeof</span>(message),<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(message,<span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message,<span class="string">"Q\n"</span>))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">		sendto(sock,message,<span class="built_in">strlen</span>(message),</span><br><span class="line">				<span class="number">0</span>,(struct sockaddr *) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">		addr_size = <span class="keyword">sizeof</span>(serv_addr);</span><br><span class="line">		<span class="keyword">int</span> str_len = recvfrom(sock,message,BUF_SIZE,</span><br><span class="line">				<span class="number">0</span>,(struct sockaddr *) &amp;serv_addr,&amp;addr_size);</span><br><span class="line">		message[str_len] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Message from server:  %s"</span>,message);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭套接字</span></span><br><span class="line">	close(sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注：UDP客户端套接字的地址分配：调用sendto函数时自动分配IP和端口号。</strong></p>
<h2 id="4-UDP的数据传输特性"><a href="#4-UDP的数据传输特性" class="headerlink" title="4. UDP的数据传输特性"></a>4. UDP的数据传输特性</h2><p>UDP具有数据边界，传输过程中调用I/O函数的次数必须完全一致。<br>因为存在数据边界, 一个数据报即可成为一个完整数据,所以UDP套接字传输的数据包又称为数据报。</p>
<h2 id="5-未连接UDP套接字与已连接UDP套接字"><a href="#5-未连接UDP套接字与已连接UDP套接字" class="headerlink" title="5. 未连接UDP套接字与已连接UDP套接字"></a>5. 未连接UDP套接字与已连接UDP套接字</h2><ul>
<li>UDP套接字默认都是未连接套接字,每次sendto都要经历三个阶段：<ul>
<li>向UDP套接字注册目标IP和端口号</li>
<li>交换数据</li>
<li>删除UDP套接字中注册的目标地址信息</li>
</ul>
</li>
<li>如果连续想同一个IP地址和端口发送数据，未连接套接字浪费</li>
<li>已连接UDP套接字<br>创建已连接UDP套接字只需要针对套接字调用connect函数即可。之后可以使用sendto，recvfrom函数进行数据交换，还可以使用write，read函数交换数据。</li>
<li>示例：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">connect(sock,(struct sockaddr *) &amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fputs</span>(<span class="string">"Insert message(q to quit): "</span>,<span class="built_in">stdout</span>);</span><br><span class="line">	fgets(message, <span class="keyword">sizeof</span>(message),<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(message,<span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message,<span class="string">"Q\n"</span>))</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	sendto(sock,message,strlen(message),</span></span><br><span class="line"><span class="comment">			0,(struct sockaddr *) &amp;serv_addr,sizeof(serv_addr));</span></span><br><span class="line"><span class="comment">	addr_size = sizeof(serv_addr);</span></span><br><span class="line"><span class="comment">	int str_len = recvfrom(sock,message,BUF_SIZE,</span></span><br><span class="line"><span class="comment">			0,(struct sockaddr *) &amp;serv_addr,&amp;addr_size);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">	write(sock,message,<span class="built_in">strlen</span>(message));</span><br><span class="line">	<span class="keyword">int</span> str_len=read(sock,message,BUF_SIZE);</span><br><span class="line"></span><br><span class="line">	message[str_len] = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Message from server:  %s"</span>,message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="第七章-优雅地断开套接字连接"><a href="#第七章-优雅地断开套接字连接" class="headerlink" title="第七章 优雅地断开套接字连接"></a>第七章 优雅地断开套接字连接</h1><h2 id="1-基于TCP的半关闭"><a href="#1-基于TCP的半关闭" class="headerlink" title="1. 基于TCP的半关闭"></a>1. 基于TCP的半关闭</h2><p>半关闭：只关闭一部分数据交换中使用的流，即只关闭一个方向的数据交换。</p>
<h2 id="2-针对半关闭的shutdown-函数"><a href="#2-针对半关闭的shutdown-函数" class="headerlink" title="2. 针对半关闭的shutdown()函数"></a>2. 针对半关闭的shutdown()函数</h2><ul>
<li><p>原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shutdown</span> <span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> howto)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock — 要断开的套接字文件描述符</li>
<li>howto — 断开方式</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">howto值</th>
<th style="text-align:center">断开方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SHUT_RD</td>
<td style="text-align:center">断开输入流</td>
</tr>
<tr>
<td style="text-align:center">SHUT_WR</td>
<td style="text-align:center">断开输出流</td>
</tr>
<tr>
<td style="text-align:center">SHUT_RDWR</td>
<td style="text-align:center">同时断开I/O流</td>
</tr>
</tbody>
</table>
<ul>
<li>返回值：成功返回0,失败返回-1</li>
</ul>
<h1 id="第八章-域名及网络地址"><a href="#第八章-域名及网络地址" class="headerlink" title="第八章 域名及网络地址"></a>第八章 域名及网络地址</h1><h2 id="1-域名系统"><a href="#1-域名系统" class="headerlink" title="1. 域名系统"></a>1. 域名系统</h2><ul>
<li>DNS是对IP地址和域名进行转换的系统，其核心是DNS服务器。</li>
</ul>
<h2 id="2-利用域名获取IP地址"><a href="#2-利用域名获取IP地址" class="headerlink" title="2. 利用域名获取IP地址"></a>2. 利用域名获取IP地址</h2><p><strong>gethostbyname函数</strong></p>
<ul>
<li>包含头文件：&lt;netdb.h&gt;</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *hostname)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：<br>  hotname — 域名字符串</p>
</li>
<li>返回值：<br>  成功时返回hostent结构体地址，失败时返回NULL指针</li>
</ul>
<p><strong>hostent结构体</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> *h_name;			<span class="comment">/* Official name of host.  */</span></span><br><span class="line">  <span class="keyword">char</span> **h_aliases;		<span class="comment">/* Alias list.  */</span></span><br><span class="line">  <span class="keyword">int</span> h_addrtype;		<span class="comment">/* Host address type.  */</span></span><br><span class="line">  <span class="keyword">int</span> h_length;			<span class="comment">/* Length of address.  */</span></span><br><span class="line">  <span class="keyword">char</span> **h_addr_list;		<span class="comment">/* List of addresses from name server.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>h_name：官方域名</li>
<li>h_aliases：多个域名列表</li>
<li>h_addrtype：地址类型，若是IPv4，则词变量为AF_INET</li>
<li>h_length：IP地址长度。若是IPv4，为4,若是IPv6，为16</li>
<li>h_addr_list：以整数形式保存的域名对应的IP地址</li>
</ul>
<h2 id="3-利用IP地址获取域名"><a href="#3-利用IP地址获取域名" class="headerlink" title="3. 利用IP地址获取域名"></a>3. 利用IP地址获取域名</h2><p><strong>gethostbyaddr函数</strong></p>
<ul>
<li>包含头文件：&lt;netdb.h&gt;</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct hostent *<span class="title">gethostbyaddr</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *addr, <span class="keyword">socklen_t</span> len, <span class="keyword">int</span> family)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>addr — 含有IP地址信息的in_addr结构体指针。为了同时传递IPv4地址之外的信息，该变量的类型声明为char型指针。</li>
<li>len — 第一个参数地址信息的字节数，IPv4为4,IPv6为16</li>
<li>family — 地址族信息，IPv4时为AF_INET，IPv6时为AF_INET6</li>
</ul>
</li>
<li>示例：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> * <span class="title">host</span>;</span></span><br><span class="line">	host = gethostbyname(argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Official name: %s \n"</span>, host-&gt;h_name);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;host-&gt;h_aliases[i];i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Aliases %d: %s \n"</span>, i+<span class="number">1</span>, host-&gt;h_aliases[i]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Address type: %s \n"</span>,</span><br><span class="line">			(host-&gt;h_addrtype==AF_INET)?<span class="string">"AF_INET"</span>:<span class="string">"AF_INET6"</span>);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;host-&gt;h_addr_list[i];i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"IP addr %d : %s \n"</span>,i+<span class="number">1</span>,</span><br><span class="line">				inet_ntoa(*(struct in_addr*)host-&gt;h_addr_list[i]));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">$./gethostbyname baidu.com</span></span><br><span class="line"><span class="comment">Official name: baidu.com </span></span><br><span class="line"><span class="comment">Address type: AF_INET </span></span><br><span class="line"><span class="comment">IP addr 1 : 180.149.132.47 </span></span><br><span class="line"><span class="comment">IP addr 2 : 220.181.57.217 </span></span><br><span class="line"><span class="comment">IP addr 3 : 111.13.101.208 </span></span><br><span class="line"><span class="comment">IP addr 4 : 123.125.114.144 </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> * <span class="title">host</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(addr));</span><br><span class="line">	addr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">	host = gethostbyaddr((<span class="keyword">char</span>*)&amp;addr.sin_addr,<span class="number">4</span>,AF_INET);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Official name: %s \n"</span>, host-&gt;h_name);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;host-&gt;h_aliases[i];i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Aliases %d: %s \n"</span>, i+<span class="number">1</span>, host-&gt;h_aliases[i]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Address type: %s \n"</span>,</span><br><span class="line">			(host-&gt;h_addrtype==AF_INET)?<span class="string">"AF_INET"</span>:<span class="string">"AF_INET6"</span>);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;host-&gt;h_addr_list[i];i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"IP addr %d : %s \n"</span>,i+<span class="number">1</span>,</span><br><span class="line">				inet_ntoa(*(struct in_addr*)host-&gt;h_addr_list[i]));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">$ ./gethostbyaddr 127.0.0.1</span></span><br><span class="line"><span class="comment">Official name: localhost </span></span><br><span class="line"><span class="comment">Address type: AF_INET </span></span><br><span class="line"><span class="comment">IP addr 1 : 127.0.0.1 </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h1 id="第九章-套接字的多种选项"><a href="#第九章-套接字的多种选项" class="headerlink" title="第九章 套接字的多种选项"></a>第九章 套接字的多种选项</h1><h2 id="1-套接字选项"><a href="#1-套接字选项" class="headerlink" title="1. 套接字选项"></a>1. 套接字选项</h2><p><strong>getsockopt()</strong></p>
<ul>
<li>头文件 <code>&lt;sys/socket.h&gt;</code></li>
<li>功能：获取套接字选项</li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getsockopt</span> <span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname,</span></span></span><br><span class="line"><span class="function"><span class="params">		       <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> *optlen)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock — 用于查看套接字选项的套接字文件描述符</li>
<li>level — 要查看选项的协议层</li>
<li>optname — 要查看的选项名</li>
<li>optval — 保存结果的缓冲地址值</li>
<li>optlen — 保存通过第四个参数返回的可选项信息的字节数</li>
</ul>
</li>
<li>返回值<br>  成功返回0,失败返回-1</li>
</ul>
<p><strong>setsockopt()</strong></p>
<ul>
<li>头文件 <code>&lt;sys/socket.h&gt;</code></li>
<li><p>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span> <span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname,</span></span></span><br><span class="line"><span class="function"><span class="params">		       <span class="keyword">const</span> <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> optlen)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>sock — 要设置可选项的套接字文件描述符</li>
<li>level — 要设置的选项的协议层</li>
<li>optname — 要设置的选项名</li>
<li>optval — 存有要设置的选项信息的缓冲地址值</li>
<li>optlen — 向参数optval传递的选项信息的字节数</li>
</ul>
</li>
<li>返回值：<br>  成功返回0,失败返回-1</li>
</ul>
<h2 id="2-I-O缓冲大小选项-SO-SNDBUF-amp-SO-RECVBUF"><a href="#2-I-O缓冲大小选项-SO-SNDBUF-amp-SO-RECVBUF" class="headerlink" title="2. I/O缓冲大小选项 SO_SNDBUF &amp; SO_RECVBUF"></a>2. I/O缓冲大小选项 SO_SNDBUF &amp; SO_RECVBUF</h2><ul>
<li>SO_RECVBUF是输入缓冲大小可选项</li>
<li>SO_SNDBUF是输出缓冲大小可选项</li>
<li>示例：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">int</span> snd_buf,rcv_buf,state;</span><br><span class="line">	<span class="keyword">socklen_t</span> len;</span><br><span class="line">	</span><br><span class="line">	sock = socket(PF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">	len = <span class="keyword">sizeof</span>(snd_buf);</span><br><span class="line">	state = getsockopt(sock,SOL_SOCKET,SO_SNDBUF,(<span class="keyword">void</span> *)&amp;snd_buf,&amp;len);</span><br><span class="line">	</span><br><span class="line">	len = <span class="keyword">sizeof</span>(snd_buf);</span><br><span class="line">	state = getsockopt(sock,SOL_SOCKET,SO_RCVBUF,(<span class="keyword">void</span> *)&amp;rcv_buf,&amp;len);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Input buffer size: %d \n"</span>, rcv_buf);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Outupt buffer size: %d \n"</span>, snd_buf);</span><br><span class="line">	</span><br><span class="line">	snd_buf /= <span class="number">4</span>;</span><br><span class="line">	rcv_buf /= <span class="number">4</span>;</span><br><span class="line">	</span><br><span class="line">	state = setsockopt(sock,SOL_SOCKET,SO_SNDBUF,(<span class="keyword">void</span> *)&amp;snd_buf,<span class="keyword">sizeof</span>(snd_buf));</span><br><span class="line">	state = setsockopt(sock,SOL_SOCKET,SO_RCVBUF,(<span class="keyword">void</span> *)&amp;rcv_buf,<span class="keyword">sizeof</span>(rcv_buf));</span><br><span class="line"></span><br><span class="line">	len = <span class="keyword">sizeof</span>(snd_buf);</span><br><span class="line">	state = getsockopt(sock,SOL_SOCKET,SO_SNDBUF,(<span class="keyword">void</span> *)&amp;snd_buf,&amp;len);</span><br><span class="line">	</span><br><span class="line">	len = <span class="keyword">sizeof</span>(snd_buf);</span><br><span class="line">	state = getsockopt(sock,SOL_SOCKET,SO_RCVBUF,(<span class="keyword">void</span> *)&amp;rcv_buf,&amp;len);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Input buffer size: %d \n"</span>, rcv_buf);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Outupt buffer size: %d \n"</span>, snd_buf);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">Input buffer size: 87380 </span></span><br><span class="line"><span class="comment">Outupt buffer size: 16384 </span></span><br><span class="line"><span class="comment">Input buffer size: 43690 </span></span><br><span class="line"><span class="comment">Outupt buffer size: 8192 </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h2 id="3-地址再分配选项-SO-REUSEADDR-和Time-wait状态"><a href="#3-地址再分配选项-SO-REUSEADDR-和Time-wait状态" class="headerlink" title="3. 地址再分配选项 SO_REUSEADDR 和Time-wait状态"></a>3. 地址再分配选项 SO_REUSEADDR 和Time-wait状态</h2><p><strong>Time-wait状态</strong></p>
<ul>
<li>Time-wait状态出现在主动断开连接的一方，即先调用close()的一方</li>
<li>Time-wait状态的设置是为了确保最后一条ACK消息的准确到达</li>
<li>Time-wait并非只有优点</li>
</ul>
<p><strong>SO_REUSEADDR选项</strong></p>
<p>SO_REUSEADDR默认设置为0,意味着无法分配Time-wait状态下的套接字端口号。将该选项设置为1,则可将Time-wait状态下的套接字端口号重新分配给新的套接字。</p>
<h2 id="4-Nagle算法选项-TCP-NODELAY"><a href="#4-Nagle算法选项-TCP-NODELAY" class="headerlink" title="4. Nagle算法选项 TCP_NODELAY"></a>4. Nagle算法选项 TCP_NODELAY</h2><p><strong>Nagle算法</strong></p>
<ul>
<li>TCP默认使用Nagle算法交换数据，因此最大限度地进行缓冲，直到收到ACK。也就是只有收到前一数据的ACK消息时，才发送下一数据。</li>
<li>根据传输数据的特性，在网络流量未受太大影响时，不使用Nagle算法要比使用它时传输速度快。典型的是“传输大文件数据”。</li>
</ul>
<p><strong>禁用Nagle算法</strong></p>
<ul>
<li>如果有必要可以禁用Nagle算法</li>
<li>将TCP_NODELAY改为1即可禁用Nagle算法。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Keaper" />
            
              <p class="site-author-name" itemprop="name">Keaper</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/J-keaper" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keaper</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
